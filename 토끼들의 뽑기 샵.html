<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í† ë¼ë“¤ì˜ ë½‘ê¸° ìƒµ</title>
  <style>
    /* ===== ì „ì²´ ìŠ¤íƒ€ì¼ (íŒŒìŠ¤í…” í†¤) ===== */
    :root{
      --pastel-bg: #ffeef5; /* ì—°í•œ í•‘í¬ */
      --sky: #d9f7ff;       /* íŒŒìŠ¤í…” í•˜ëŠ˜ */
      --card: #fff7fb;      /* ì¹´ë“œ ë°°ê²½ */
      --ink: #444;          /* í…ìŠ¤íŠ¸ */
      --accent: #ffb3c7;    /* í¬ì¸íŠ¸ */
      --mint: #c9f7e9;      /* í¬ì¸íŠ¸ 2 */
      --lav: #e7ddff;       /* í¬ì¸íŠ¸ 3 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: var(--pastel-bg);
      font-family: "Pretendard", "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      color:var(--ink);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px;
    }

    /* ===== ê²Œì„ ì»¨í…Œì´ë„ˆ ===== */
    .wrap{
      width:min(980px, 100vw - 24px);
      padding:16px;
      border-radius:20px;
      background:linear-gradient(180deg, #ffffffaa, #ffffff55), var(--mint);
      box-shadow:0 12px 30px rgba(0,0,0,0.12);
    }
    h1{
      margin:0 0 10px;
      font-size:clamp(20px, 3vw, 28px);
      display:flex;gap:10px;align-items:center;justify-content:center;
    }
    h1 .tag{font-size:0.7em;background:var(--lav);padding:4px 10px;border-radius:999px}

    /* ìƒë‹¨ ì •ë³´ ë°” */
    .hud{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:10px;
      margin:8px 0 12px;
    }
    .chip{
      background:var(--card);
      border:2px solid #fff;
      padding:8px 12px;
      border-radius:16px;
      font-weight:700;
      display:flex;gap:8px;align-items:center;justify-content:center;
      box-shadow:0 2px 0 #fff inset, 0 6px 12px rgba(0,0,0,0.06);
    }
    .left,.right{display:flex;gap:8px;align-items:center}
    .right{justify-content:flex-end}
    .btn{cursor:pointer;border:none;background:var(--accent);color:#fff;font-weight:800;padding:8px 12px;border-radius:12px;box-shadow:0 4px 0 #e99;transition:transform .06s}
    .btn:active{transform:translateY(2px)}
    .muted{background:#c7c7c7;color:#333;box-shadow:0 4px 0 #9e9e9e}

    /* ìº”ë²„ìŠ¤ ì¹´ë“œ */
    .stage{
      background: var(--sky);
      border:6px solid #fff0f5;
      border-radius:20px;
      position:relative;
      overflow:hidden;
      width:100%;
      aspect-ratio: 16/9;
    }
    canvas{display:block;width:100%;height:100%}

    /* ì»¨íŠ¸ë¡¤ ë°” */
    .controls{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin-top:10px;
    }
    .range{display:flex;gap:8px;align-items:center;background:#fff;padding:6px 10px;border-radius:12px;border:2px solid #fff}
    input[type="range"]{width:260px}
    .scale-hint{font-size:12px;opacity:.8}

    /* ì‹œì‘ ì˜¤ë²„ë ˆì´: í† ë¼ ì•„ì´ì½˜ì„ ëˆŒëŸ¬ ì‹œì‘ */
    .overlay{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;
      background:linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.5));
      backdrop-filter: blur(2px);
      gap:14px;text-align:center;padding:20px;
    }
    .startBtn{
      width:140px;height:140px;border-radius:50%;
      border:6px solid #fff;box-shadow:0 12px 24px rgba(0,0,0,0.15);
      display:grid;place-items:center;font-size:72px;cursor:pointer;
      background: radial-gradient(circle at 30% 30%, #fff, #ffe4ec);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .startBtn:hover{transform:translateY(-2px);box-shadow:0 16px 30px rgba(0,0,0,0.2)}
    .hint{font-size:14px;opacity:.8}

    /* ê²°ê³¼ ì˜¤ë²„ë ˆì´ */
    .result{
      position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;
      background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.6));
      text-align:center;gap:10px;padding:20px;
    }
    .result .card{
      background:#fff;border-radius:16px;padding:16px 18px;box-shadow:0 10px 24px rgba(0,0,0,0.18);
      min-width: min(520px, 90%);
    }
    .result h2{margin:0 0 6px}
    .result .stat{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:10px 0}
    .result .stat .chip{min-width:120px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ° í† ë¼ë“¤ì˜ ë½‘ê¸° ìƒµ <span class="tag">30ì´ˆ íƒ€ì„ì–´íƒ</span></h1>

    <div class="hud">
      <div class="left">
        <div class="chip" id="scoreChip">ì ìˆ˜: <b id="score">0</b></div>
        <div class="chip">ë ˆë²¨: <b id="level">1</b> / 10</div>
      </div>
      <div class="chip" id="timerChip">â³ ë‚¨ì€ì‹œê°„: <b id="time">30.0</b>s</div>
      <div class="right">
        <button class="btn" id="muteBtn" title="ë°°ê²½ìŒì•… í† ê¸€">ğŸ”Š BGM</button>
        <button class="btn" id="restartBtn" title="ë‹¤ì‹œ ì‹œì‘">â†» ì¬ì‹œì‘</button>
      </div>
    </div>

    <div class="stage" id="stage">
      <canvas id="game" width="960" height="540" aria-label="game"></canvas>
      <!-- ì‹œì‘ ì˜¤ë²„ë ˆì´: í† ë¼ ì•„ì´ì½˜ í´ë¦­ ì‹œ ì‹œì‘ -->
      <div class="overlay" id="startOverlay" role="dialog" aria-live="polite">
        <div class="startBtn" id="startBtn" title="ì‹œì‘í•˜ê¸°">ğŸ‡</div>
        <div class="hint">í† ë¼ ì•„ì´ì½˜ì„ ëˆ„ë¥´ê±°ë‚˜ Enter í‚¤ë¥¼ ëˆŒëŸ¬ ì‹œì‘!<br/>ì¢Œ/ìš° ë°©í–¥í‚¤ë¡œ í† ë¼ë¥¼ ì›€ì§ì—¬ ì¸í˜•(ğŸ¥•ğŸ‡ğŸ¥¬)ì„ ë°›ì•„ìš”.</div>
        <div class="hint">ì‘ì€ 1ì  Â· ì¤‘ê°„ 5ì  Â· í° 10ì  / 10, 30, 60 â€¦ ì ì—ì„œ ë ˆë²¨ì—…(ìµœëŒ€ 10)</div>
      </div>
      
      <!-- ê²°ê³¼ ì˜¤ë²„ë ˆì´ -->
      <div class="result" id="resultOverlay">
        <div class="card">
          <h2>âŒ› ì¢…ë£Œ! ê²°ê³¼</h2>
          <div class="stat">
            <div class="chip">ìµœì¢… ì ìˆ˜: <b id="finalScore">0</b></div>
            <div class="chip">ë‹¬ì„± ë ˆë²¨: <b id="finalLevel">1</b> / 10</div>
            <div class="chip">ì´ ë½‘ê¸° ìˆ˜: <b id="finalCatch">0</b></div>
          </div>
          <button class="btn" id="againBtn">ë‹¤ì‹œí•˜ê¸°</button>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="range">
        <span>ë‚´ë ¤ì˜¤ëŠ” ì†ë„</span>
        <!-- ì–´ë¦°ì´ë„ ì‰½ê²Œ: 0.03ë°°ê¹Œì§€, ì„±ì¸ ë„ì „: 2.5ë°°ê¹Œì§€ -->
        <input type="range" id="speedControl" min="0.03" max="2.50" step="0.01" value="0.30">
        <span id="speedLabel">Ã—0.30 (ì–´ë¦°ì´)</span>
      </div>
      <div class="scale-hint">â—€ï¸ ì•„ì£¼ ëŠë¦¼(ì–´ë¦°ì´) ï½œ ë³´í†µ Ã—1.0 ï½œ ì•„ì£¼ ë¹ ë¦„(ì„±ì¸) â–¶ï¸</div>
    </div>
  </div>

  <script>
  /* =============================================================
     í† ë¼ë“¤ì˜ ë½‘ê¸° ìƒµ â€” HTML5 Canvas ê²Œì„ (ì–´ë¦°ì´â†”ì„±ì¸ ì†ë„ì¡°ì ˆ)
     ë°˜ì˜ ì‚¬í•­:
     - ë°©í–¥í‚¤ ì¡°ì‘, í† ë¼ ì•„ì´ì½˜(ë˜ëŠ” Enter)ë¡œ ì‹œì‘
     - 30ì´ˆ íƒ€ì´ë¨¸ & í’ì„  íŒ ì‹œê°í™”
     - ì¸í˜• 3ì¢…(ğŸ¥•/ğŸ‡/ğŸ¥¬), í™•ë¥ : ì¤‘=ì‘ì˜ 1/3, ëŒ€=ì‘ì˜ 1/5
     - ì ìˆ˜ 1/5/10, í¬ê¸° í´ìˆ˜ë¡ ë” ë¹ ë¥´ê²Œ
     - ì†ë„ ìŠ¬ë¼ì´ë”: 0.03ë°°(ì–´ë¦°ì´) ~ 2.50ë°°(ì„±ì¸)
     - ë ˆë²¨ì—…(10, 30, 60, 100, 150, 210, 280, 360, 450, 550) ìµœëŒ€ 10ë ˆë²¨
     - íŒŒìŠ¤í…” í†¤ UI, ê°„ë‹¨í•œ BGM/íš¨ê³¼ìŒ(í† ê¸€ ê°€ëŠ¥)
  ============================================================= */

  // ---------- ìº”ë²„ìŠ¤ / ì»¨í…ìŠ¤íŠ¸ ----------
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  // ---------- DOM ìš”ì†Œ ----------
  const startOverlay = document.getElementById('startOverlay');
  const startBtn = document.getElementById('startBtn');
  const resultOverlay = document.getElementById('resultOverlay');
  const scoreEl = document.getElementById('score');
  const levelEl = document.getElementById('level');
  const timeEl = document.getElementById('time');
  const restartBtn = document.getElementById('restartBtn');
  const againBtn = document.getElementById('againBtn');
  const finalScoreEl = document.getElementById('finalScore');
  const finalLevelEl = document.getElementById('finalLevel');
  const finalCatchEl = document.getElementById('finalCatch');
  const muteBtn = document.getElementById('muteBtn');
  const speedControl = document.getElementById('speedControl');
  const speedLabel = document.getElementById('speedLabel');

  // ---------- ê²Œì„ ìƒìˆ˜ ----------
  const GAME_TIME = 30_000; // 30ì´ˆ ms
  const GRAVITY_BASE = 0.02; // ê¸°ë³¸ ê°€ì† (ë ˆë²¨ ë³´ì •, ì†ë„ìŠ¬ë¼ì´ë” ì ìš©)
  const PLAYER_SPEED = 0.6;  // í† ë¼ ì¢Œ/ìš° ì´ë™ ì†ë„
  const PLAYER_WIDTH = 70;
  const PLAYER_HEIGHT = 60;

  // ì¸í˜• íƒ€ì… ì •ì˜(ì´ëª¨ì§€, í¬ê¸°, ì ìˆ˜, ê¸°ë³¸ ì†ë„ ë°°ìœ¨, ê°€ì¤‘ì¹˜)
  // í™•ë¥ : medium = smallì˜ 1/3, large = smallì˜ 1/5 (ì‘:15, ì¤‘:5, ëŒ€:3)
  const TOY_TYPES = [
    { name:'small', emoji:'ğŸ¥•', size:34, score:1,  speed:1.00, weight:15 },
    { name:'medium',emoji:'ğŸ‡', size:42, score:5,  speed:1.25, weight:5  },
    { name:'large', emoji:'ğŸ¥¬', size:54, score:10, speed:1.55, weight:3  },
  ];

  // ë ˆë²¨ì—… ëˆ„ì  ì ìˆ˜ ì„ê³„ì¹˜(10â†’20â†’30â€¦ ì¦ê°€)
  const LEVEL_THRESHOLDS = [10,30,60,100,150,210,280,360,450,550];
  const MAX_LEVEL = 10;

  // ---------- ê²Œì„ ìƒíƒœ ----------
  let running = false;
  let startTime = 0;
  let elapsed = 0;
  let score = 0;
  let level = 1; // 1~10
  let catchCount = 0;
  let toys = [];
  let keys = new Set();
  let speedFactor = parseFloat(speedControl.value); // 0.03 ~ 2.5

  const player = {
    x: canvas.width/2,
    y: canvas.height - PLAYER_HEIGHT - 10,
    w: PLAYER_WIDTH,
    h: PLAYER_HEIGHT,
    vx: 0,
  };

  // ---------- ìœ í‹¸ ----------
  function rand(min,max){ return Math.random()*(max-min)+min; }
  function choiceWeighted(){
    const total = TOY_TYPES.reduce((s,t)=>s+t.weight,0);
    let r = Math.random()*total;
    for(const t of TOY_TYPES){
      if(r < t.weight) return t;
      r-=t.weight;
    }
    return TOY_TYPES[0];
  }

  // ë ˆë²¨ ë³´ì •ì¹˜: ë ˆë²¨ì´ ì˜¤ë¥¼ìˆ˜ë¡ ì¤‘ë ¥/ìŠ¤í° ì†ë„ ì•½ê°„ ì¦ê°€
  function levelGravityScale(){ return 1 + (level-1)*0.08; }
  function levelSpawnInterval(){
    const base = 680; // ms
    const min = 260;  // í•˜í•œ
    const ms = base - (level-1)*42;
    return Math.max(min, ms);
  }

  // ---------- ì˜¤ë””ì˜¤ (ê°„ë‹¨í•œ BGM + íš¨ê³¼ìŒ) ----------
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let actx = null;
  let bgmNode = null;
  let bgmGain = null;
  let sfxGain = null;
  let muted = false;

  function initAudio(){
    if(actx) return;
    actx = new AudioCtx();
    const master = actx.createGain();
    master.gain.value = 0.9;
    master.connect(actx.destination);

    bgmGain = actx.createGain();
    bgmGain.gain.value = 0.12; // ì”ì”í•˜ê²Œ
    bgmGain.connect(master);

    sfxGain = actx.createGain();
    sfxGain.gain.value = 0.35;
    sfxGain.connect(master);
  }

  function toggleMute(){
    muted = !muted;
    if(!actx) return;
    const v = muted ? 0 : 1;
    bgmGain.gain.setTargetAtTime(0.12*v, actx.currentTime, 0.05);
    sfxGain.gain.setTargetAtTime(0.35*v, actx.currentTime, 0.05);
    muteBtn.classList.toggle('muted', muted);
    muteBtn.textContent = muted ? 'ğŸ”‡ BGM' : 'ğŸ”Š BGM';
  }

  function playSFX(type='hit'){
    if(!actx || muted) return;
    const o = actx.createOscillator();
    const g = actx.createGain();
    o.connect(g); g.connect(sfxGain);
    o.type = (type==='pop')? 'triangle' : (type==='lvl' ? 'sawtooth' : 'sine');
    const now = actx.currentTime;
    if(type==='hit'){ o.frequency.setValueAtTime(540, now); o.frequency.exponentialRampToValueAtTime(280, now+0.08); }
    if(type==='pop'){ o.frequency.setValueAtTime(220, now); o.frequency.exponentialRampToValueAtTime(660, now+0.12); }
    if(type==='lvl'){
      const seq=[440,554,659];
      seq.forEach((f,i)=>{ o.frequency.setValueAtTime(f, now + i*0.07); });
    }
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.4, now+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.18);
    o.start(now);
    o.stop(now+0.2);
  }

  function startBGM(){
    if(!actx || muted) return;
    if(bgmNode) { try{bgmNode.stop();}catch{} }
    const o = actx.createOscillator();
    const g = actx.createGain();
    o.connect(g); g.connect(bgmGain);
    o.type = 'triangle';
    let base = 196; // G3
    const lfo = actx.createOscillator();
    const lfoGain = actx.createGain();
    lfo.frequency.value = 0.4; lfoGain.gain.value = 24; // ì§„ë™í­
    lfo.connect(lfoGain); lfoGain.connect(o.frequency);
    lfo.start();
    let t = 0;
    const seq = [base, base*1.26, base, base*1.5];
    const int = setInterval(()=>{
      if(!running){ clearInterval(int); try{lfo.stop();}catch{} }
      t = (t+1)%seq.length;
      o.frequency.setTargetAtTime(seq[t], actx.currentTime, 0.12);
    }, 600);
    o.start();
    bgmNode = o;
  }

  // ---------- ì˜¤ë¸Œì íŠ¸: ì¥ë‚œê°(ì¸í˜•) ----------
  class Toy{
    constructor(){
      const t = choiceWeighted();
      this.type = t;
      this.x = rand(20, canvas.width-20);
      this.y = -t.size;
      // ê¸°ë³¸ ì´ˆê¸° ë‚™í•˜ì†ë„ (ëŠë¦° ìª½ìœ¼ë¡œ í•˜í–¥ ì¡°ì •)
      this.vy = rand(0.20, 0.36) * t.speed; // base
      this.size = t.size;
      this.dead = false;
    }
    update(dt){
      // ì¤‘ë ¥ ê°€ì†(ë ˆë²¨ ë³´ì • + ì‚¬ìš©ì ì†ë„ì¡°ì ˆ ë°˜ì˜)
      this.vy += (GRAVITY_BASE * levelGravityScale() * speedFactor) * dt;
      this.y += (this.vy * speedFactor) * dt;
      // í™”ë©´ ë°–
      if(this.y - this.size > canvas.height + 40) this.dead = true;
      // í”Œë ˆì´ì–´ ì¶©ëŒ(ë‹¨ìˆœ ë°•ìŠ¤ + ì› í˜¼í•© íŒì •)
      const px = player.x, py = player.y, pw = player.w, ph = player.h;
      if(this.x > px-10 && this.x < px+pw+10 && this.y+this.size*0.4 > py && this.y-this.size*0.2 < py+ph){
        this.dead = true;
        score += this.type.score;
        catchCount++;
        playSFX('hit');
        updateLevelByScore();
      }
    }
    draw(){
      ctx.font = `${this.size}px system-ui, Apple Color Emoji, Segoe UI Emoji`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(this.type.emoji, this.x, this.y);
    }
  }

  // ---------- ìŠ¤í° íƒ€ì´ë¨¸ ----------
  let spawnTimer = 0;
  let spawnIntervalMs = levelSpawnInterval();

  function trySpawn(dt){
    spawnTimer += dt;
    if(spawnTimer >= spawnIntervalMs){
      spawnTimer = 0;
      const n = (Math.random() < 0.2) ? 2 : 1;
      for(let i=0;i<n;i++) toys.push(new Toy());
    }
  }

  // ---------- ë ˆë²¨ ì—… ë¡œì§ ----------
  function updateLevelByScore(){
    let newLevel = 1;
    for(let i=0;i<LEVEL_THRESHOLDS.length;i++){
      if(score >= LEVEL_THRESHOLDS[i]) newLevel = i+2; // 10ì  ë„ë‹¬ ì‹œ 2ë ˆë²¨ â€¦
    }
    newLevel = Math.min(newLevel, MAX_LEVEL);
    if(newLevel !== level){
      level = newLevel;
      levelEl.textContent = level;
      spawnIntervalMs = levelSpawnInterval();
      playSFX('lvl');
      levelFlashTimer = 800; // ms (í™”ë©´ í‘œì‹œ)
    }
  }

  // ---------- ì…ë ¥ ----------
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !running) { startGame(); }
    if(['ArrowLeft','ArrowRight'].includes(e.key)) keys.add(e.key);
  });
  window.addEventListener('keyup', (e)=>{
    if(['ArrowLeft','ArrowRight'].includes(e.key)) keys.delete(e.key);
  });

  // ---------- ê²Œì„ ë£¨í”„ ----------
  let lastTs = 0;
  let rafId = 0;
  let levelFlashTimer = 0;

  function loop(ts){
    rafId = requestAnimationFrame(loop);
    if(!lastTs) lastTs = ts;
    const dt = Math.min(32, ts - lastTs); // ms í´ë¨í”„
    lastTs = ts;

    // ì‹œê°„ ê²½ê³¼ & ì¢…ë£Œ ì²´í¬
    elapsed = performance.now() - startTime;
    const remain = Math.max(0, GAME_TIME - elapsed);
    timeEl.textContent = (remain/1000).toFixed(1);
    if(remain <= 0){
      finishGame();
      return;
    }

    // ì—…ë°ì´íŠ¸
    update(dt);
    // ë Œë”
    draw(remain);
  }

  function update(dt){
    // ì…ë ¥ â†’ í”Œë ˆì´ì–´ ì†ë„
    let ax = 0;
    if(keys.has('ArrowLeft')) ax -= 1;
    if(keys.has('ArrowRight')) ax += 1;
    player.vx = ax * PLAYER_SPEED * (1 + (level-1)*0.06);
    player.x += player.vx * dt;
    player.x = Math.max(8, Math.min(canvas.width - player.w - 8, player.x));

    // ìŠ¤í°
    trySpawn(dt);

    // ì¸í˜• ì—…ë°ì´íŠ¸
    for(const t of toys) t.update(dt);
    toys = toys.filter(t=>!t.dead);

    // HUD ë°˜ì˜
    scoreEl.textContent = score;
  }

  function draw(remainMs){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // í•˜ëŠ˜ ë°°ê²½ì˜ íŒŒìŠ¤í…” ê·¸ë¼ë””ì–¸íŠ¸
    const g = ctx.createLinearGradient(0,0,0,canvas.height);
    g.addColorStop(0, '#e6fbff');
    g.addColorStop(1, '#fdf1ff');
    ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width,canvas.height);

    // ë°”ë‹¥(ì¹´í«)
    ctx.fillStyle = '#fff0f5';
    ctx.fillRect(0, canvas.height-60, canvas.width, 60);

    // í’ì„ (íƒ€ì´ë¨¸ ì‹œê°í™”) â€” ë‚¨ì€ ì‹œê°„ì— ë”°ë¼ ì»¤ì§
    const t = 1 - (remainMs / GAME_TIME); // 0â†’1
    const bx = canvas.width - 90, by = 80;
    const br = 24 + t*34; // ì ì  ì»¤ì§
    // ëˆ
    ctx.strokeStyle = '#e4a1b7';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(bx, by+br);
    ctx.lineTo(bx, by+br+28);
    ctx.stroke();
    // ë³¸ì²´
    ctx.fillStyle = '#ffc2d6';
    ctx.beginPath();
    ctx.ellipse(bx, by, br*0.9, br, 0, 0, Math.PI*2);
    ctx.fill();
    // í•˜ì´ë¼ì´íŠ¸
    ctx.fillStyle = 'rgba(255,255,255,0.6)';
    ctx.beginPath(); ctx.ellipse(bx-8, by-10, br*0.22, br*0.18, 0, 0, Math.PI*2); ctx.fill();

    // ì¸í˜• ë“œë¡œìš°
    for(const toy of toys) toy.draw();

    // í”Œë ˆì´ì–´(í•˜ì–€ í† ë¼)
    drawBunny(player.x, player.y, player.w, player.h);

    // ë ˆë²¨ì—… í”Œë˜ì‹œ í…ìŠ¤íŠ¸
    if(levelFlashTimer > 0){
      levelFlashTimer -= 16;
      ctx.save();
      ctx.globalAlpha = Math.max(0, levelFlashTimer/800);
      ctx.fillStyle = '#6a4c93';
      ctx.font = 'bold 36px Pretendard, sans-serif';
      ctx.textAlign='center'; ctx.textBaseline='top';
      ctx.fillText(`Level ${level} !`, canvas.width/2, 20);
      ctx.restore();
    }
  }

  function drawBunny(x,y,w,h){
    // ê°„ë‹¨í•œ í† ë¼(íŒŒìŠ¤í…” í™”ì´íŠ¸)
    const cx = x + w/2;
    // ê·¸ë¦¼ì
    ctx.fillStyle = 'rgba(0,0,0,0.08)';
    ctx.beginPath(); ctx.ellipse(cx, y+h+10, w*0.55, 8, 0, 0, Math.PI*2); ctx.fill();

    // ê·€
    ctx.fillStyle = '#fff';
    ctx.strokeStyle = '#f0e9ff';
    ctx.lineWidth = 2;
    const earW = w*0.22, earH = h*0.75;
    // ì™¼
    ctx.beginPath(); ctx.ellipse(cx - w*0.18, y + 4, earW, earH, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    // ì˜¤
    ctx.beginPath(); ctx.ellipse(cx + w*0.18, y + 4, earW, earH, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // ì–¼êµ´
    ctx.beginPath(); ctx.ellipse(cx, y + h*0.46, w*0.5, h*0.48, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // ëˆˆ
    ctx.fillStyle = '#444';
    ctx.beginPath(); ctx.arc(cx - w*0.14, y + h*0.44, 4, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx + w*0.14, y + h*0.44, 4, 0, Math.PI*2); ctx.fill();

    // ì½”/ì…
    ctx.strokeStyle = '#444'; ctx.lineWidth = 1.8;
    ctx.beginPath();
    ctx.moveTo(cx, y + h*0.50); ctx.lineTo(cx, y + h*0.54);
    ctx.moveTo(cx - 6, y + h*0.56); ctx.quadraticCurveTo(cx, y + h*0.60, cx + 6, y + h*0.56);
    ctx.stroke();

    // ë³¼í„°ì¹˜
    ctx.fillStyle = 'rgba(255, 170, 170, .6)';
    ctx.beginPath(); ctx.arc(cx - w*0.22, y + h*0.54, 5.5, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx + w*0.22, y + h*0.54, 5.5, 0, Math.PI*2); ctx.fill();
  }

  // ---------- ê²Œì„ ì œì–´ ----------
  let spawnIntHandle = null;

  function startGame(){
    initAudio(); startBGM();
    running = true;
    score = 0; level = 1; catchCount = 0; toys = [];
    levelEl.textContent = level; scoreEl.textContent = score;
    spawnIntervalMs = levelSpawnInterval();

    startTime = performance.now();
    lastTs = 0; levelFlashTimer = 0; spawnTimer = 0;

    // UI
    startOverlay.style.display = 'none';
    resultOverlay.style.display = 'none';

    cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(loop);
  }

  function finishGame(){
    running = false;
    cancelAnimationFrame(rafId);
    playSFX('pop');
    finalScoreEl.textContent = score;
    finalLevelEl.textContent = level;
    finalCatchEl.textContent = catchCount;
    resultOverlay.style.display = 'flex';
  }

  function resetToStart(){
    running = false;
    cancelAnimationFrame(rafId);
    toys = [];
    score = 0; catchCount = 0; level = 1; elapsed = 0;
    scoreEl.textContent = '0'; levelEl.textContent = '1'; timeEl.textContent = '30.0';
    startOverlay.style.display = 'flex';
    resultOverlay.style.display = 'none';
    ctx.clearRect(0,0,canvas.width,canvas.height);
  }

  // ---------- ì´ë²¤íŠ¸ ë°”ì¸ë”© ----------
  startBtn.addEventListener('click', startGame);
  restartBtn.addEventListener('click', resetToStart);
  againBtn.addEventListener('click', ()=>{ resetToStart(); startGame(); });
  muteBtn.addEventListener('click', ()=>{ initAudio(); toggleMute(); });
  speedControl.addEventListener('input', ()=>{
    speedFactor = parseFloat(speedControl.value);
    const label = speedFactor >= 1.8 ? ' (ì„±ì¸)' : (speedFactor <= 0.12 ? ' (ì–´ë¦°ì´)' : '');
    speedLabel.textContent = `Ã—${speedFactor.toFixed(2)}${label}`;
  });

  // ì´ˆê¸°ì— ì •ì§€ í™”ë©´ ê·¸ë ¤ë‘ê¸°
  (function drawIdle(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const g = ctx.createLinearGradient(0,0,0,canvas.height);
    g.addColorStop(0, '#e6fbff'); g.addColorStop(1, '#fdf1ff');
    ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#fff0f5'; ctx.fillRect(0, canvas.height-60, canvas.width, 60);

    const w=90, h=78; drawBunny(canvas.width/2 - w/2, canvas.height-60-h-10, w, h);

    ctx.fillStyle = '#5e548e';
    ctx.font = '700 28px Pretendard, sans-serif';
    ctx.textAlign='center'; ctx.fillText('í† ë¼ ì•„ì´ì½˜ì„ ëˆŒëŸ¬ ì‹œì‘!', canvas.width/2, 80);

    ctx.font = '40px system-ui, Apple Color Emoji';
    ctx.fillText('ğŸ¥•', canvas.width/2 - 120, 150);
    ctx.fillText('ğŸ‡', canvas.width/2, 130);
    ctx.fillText('ğŸ¥¬', canvas.width/2 + 120, 160);
  })();
  </script>
</body>
</html>
