<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‚¬ë§ˆê·€ì˜ ëª¨í—˜ - ë ˆë²¨ì—…/ë…¸í¬ë°±/ì™¸í˜•ë³€í™”</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body { background:#111; color:#eee; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial, sans-serif; display:flex; align-items:center; justify-content:center; }

    .wrap { width: min(960px, 100vw); aspect-ratio: 16/9; background:#1a1a1a; border:2px solid #333; border-radius:14px; box-shadow: 0 20px 50px rgba(0,0,0,.6), inset 0 0 0 4px #000; position:relative; overflow:hidden; }

    .hud { position:absolute; inset:12px 12px auto 12px; display:flex; gap:12px; align-items:center; z-index:3; font-weight:700; letter-spacing:0.2px; }
    .chip { background:#222; border:1px solid #333; padding:6px 10px; border-radius:10px; box-shadow: inset 0 1px 0 #000; }
    .gold { color:#ffd54a; }
    .green { color:#5bd17c; }
    .red { color:#ff6b6b; }
    .sky { color:#6bd1ff; }

    canvas { width:100%; height:100%; image-rendering: pixelated; display:block; }

    .help { position:absolute; inset:auto 10px 10px 10px; text-align:center; color:#9aa; font-size:12px; z-index:3; }

    /* ê³µí†µ ì˜¤ë²„ë ˆì´ */
    .overlay { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; background:linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.85)); color:#f0f6ff; z-index:5; text-align:center; padding:24px; }
    .overlay h1 { margin:0; font-size:clamp(28px, 6vw, 48px); text-shadow:0 2px 0 #000; }
    .overlay p { margin:0; opacity:0.9; line-height:1.6; }
    .count { font-size:clamp(48px, 10vw, 120px); font-weight:900; color:#7ee081; text-shadow:0 4px 0 #0b3d18, 0 0 20px rgba(126,224,129,0.4); }

    /* ìŠ¹ë¦¬/íŒ¨ë°° ë°°ë„ˆ */
    .banner { position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:6; }
    .banner .card { background:rgba(10,10,10,.9); border:1px solid #333; padding:26px 22px; border-radius:16px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.6); }
    .banner h2 { margin:6px 0 10px; font-size:28px; }
    .banner p { margin:3px 0; color:#aab; }
    .banner button { margin-top:14px; background:#2a2a2a; border:1px solid #3a3a3a; color:#eee; font-weight:700; border-radius:10px; padding:10px 14px; cursor:pointer; }
    .banner button:hover { filter:brightness(1.1); }

    /* ë ˆë²¨ì—… ì¶•í•˜ ì˜¤ë²„ë ˆì´ */
    #levelUp { display:none; }
    #levelUp .cele { font-size: clamp(28px, 5vw, 56px); color:#ffe082; text-shadow:0 0 12px rgba(255,208,64,.25); font-weight:900; }
    #levelUp .rewards { font-size: clamp(14px, 2.2vw, 18px); color:#cfe9ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hud" id="hud">
      <div class="chip">ë ˆë²¨ <span id="level" class="gold">1</span></div>
      <div class="chip">ì ìˆ˜ <span id="score" class="green">0</span> / 100</div>
      <div class="chip">ëª©ìˆ¨ <span id="lives" class="red">30</span></div>
      <div class="chip">ì²´ë ¥ <span id="hp" class="sky">3</span>/3</div>
      <div class="chip">ì•„ì´í…œ <span id="items">â€”</span></div>
    </div>

    <canvas id="game" width="960" height="540" aria-label="ì‚¬ë§ˆê·€ì˜ ëª¨í—˜ ê²Œì„ í™”ë©´"></canvas>

    <div class="help">ì¡°ì‘: â† â†’ ì´ë™, â†‘ ì í”„(ë ˆë²¨4ë¶€í„° â†‘ ìœ ì§€ ì‹œ ë¹„í–‰), SPACE ê³µê²© Â· R ì¬ì‹œì‘ Â· P ì¼ì‹œì •ì§€</div>

    <!-- ì‹œì‘ ì¹´ìš´íŠ¸ë‹¤ìš´/ìŠ¤í† ë¦¬ ì˜¤ë²„ë ˆì´ -->
    <div class="overlay" id="overlay">
      <h1>ì‚¬ë§ˆê·€ì˜ ëª¨í—˜</h1>
      <p id="story">ì•„ê¸° ì‚¬ë§ˆê·€ê°€ ì•…ë‹¹ ê³¤ì¶©ë“¤ì„ ë¬¼ë¦¬ì¹˜ê³  ë ˆë²¨ì—… 3ë²ˆì„ ê±°ì³ ì–´ë¥¸ ì‚¬ë§ˆê·€ê°€ ë©ë‹ˆë‹¤!</p>
      <div class="count" id="count">10</div>
      <p>ê³§ ì‹œì‘í•©ë‹ˆë‹¤â€¦</p>
    </div>

    <!-- ë ˆë²¨ì—… ì¶•í•˜ ì˜¤ë²„ë ˆì´ -->
    <div class="overlay" id="levelUp" role="dialog" aria-live="polite">
      <div class="cele">LEVEL UP!</div>
      <div id="levelUpText" class="rewards">ë ˆë²¨ 2 ë‹¬ì„±! ë³´ìƒ: ê°‘ì˜·</div>
    </div>

    <!-- ìŠ¹ë¦¬/íŒ¨ë°° ë°°ë„ˆ -->
    <div class="banner" id="winBanner" role="dialog" aria-live="polite">
      <div class="card">
        <h2>ìŠ¹ë¦¬! ğŸ‰</h2>
        <p>ë³´ìŠ¤ ë¼ì§€ì—¬ì¹˜ë¥¼ ë¬¼ë¦¬ì³¤ìŠµë‹ˆë‹¤.</p>
        <p>ì‚¬ë§ˆê·€ëŠ” ì•Œì„ ë‚³ê³ , ì¡°ìš©íˆ ìˆ²ì„ ë– ë‚©ë‹ˆë‹¤â€¦ ğŸ¥šâœ¨</p>
        <button id="restartWin">ë‹¤ì‹œ ì‹œì‘</button>
      </div>
    </div>

    <div class="banner" id="loseBanner" role="dialog" aria-live="polite">
      <div class="card">
        <h2>ê²Œì„ ì˜¤ë²„ ğŸ’€</h2>
        <p>ë‹¤ìŒì—” ë” ê°•í•´ì ¸ì„œ ëŒì•„ì˜¤ì„¸ìš”!</p>
        <button id="restartLose">ë‹¤ì‹œ ì‹œì‘</button>
      </div>
    </div>
  </div>

  <script>
    // ===== ê¸°ë³¸ ì…‹ì—… =====
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
    const rnd = (a,b)=> Math.random()*(b-a)+a;

    const GROUND_Y = 460;
    const GRAVITY = 0.7;
    const FRICTION = 0.8;
    const WORLD_LEFT = 0;
    const WORLD_RIGHT = canvas.width;

    const LEVEL_ENEMY_NAME = { 1:'ì•„ê¸°ì‚¬ë§ˆê·€', 2:'ê·€ëšœë¼ë¯¸', 3:'ë°©ê·€ì¥ìˆ˜ë…¸ë¦°ì¬', 4:'ë²¼ë©”ëšœê¸°', 5:'ë³´ìŠ¤ ë¼ì§€ì—¬ì¹˜' };

    // HUD
    const hud = {
      level: document.getElementById('level'),
      score: document.getElementById('score'),
      lives: document.getElementById('lives'),
      hp: document.getElementById('hp'),
      items: document.getElementById('items')
    };

    // ì˜¤ë²„ë ˆì´/ë°°ë„ˆ
    const overlay = document.getElementById('overlay');
    const levelUpOverlay = document.getElementById('levelUp');
    const levelUpText = document.getElementById('levelUpText');
    const countEl = document.getElementById('count');
    const storyEl = document.getElementById('story');
    const winBanner = document.getElementById('winBanner');
    const loseBanner = document.getElementById('loseBanner');
    const restartWin = document.getElementById('restartWin');
    const restartLose = document.getElementById('restartLose');

    // ì…ë ¥
    const keys = new Set();
    window.addEventListener('keydown', (e)=>{ if(['ArrowLeft','ArrowRight','ArrowUp','Space',' '].includes(e.code||e.key)) e.preventDefault(); keys.add(e.code||e.key); });
    window.addEventListener('keyup', (e)=>{ keys.delete(e.code||e.key); });

    // ===== í”Œë ˆì´ì–´ =====
    class Player{
      constructor(){ this.reset(); }
      reset(){
        this.x=120; this.y=GROUND_Y; this.w=30; this.h=38;
        this.vx=0; this.vy=0; this.dir=1; this.onGround=true;
        this.hp=3; this.lives=30; this.score=0; this.level=1; this.cool=0; this.items=[];
        this.hasArmor=false; this.longArms=false; this.hasWings=false; this.isGold=false; this.attackFrames=0; this.swingAngle=0;
      }
      addScore(n){
        this.score += n;
        // 100ì ë§ˆë‹¤ ë ˆë²¨ì—… ì²´í¬
        while(this.score >= this.level*100 && this.level < 5){
          this.level++;
          // ë³´ìƒ ì§€ê¸‰ì€ ì¦‰ì‹œ, ê²Œì„ì€ 3ì´ˆê°„ ë ˆë²¨ì—… ì—°ì¶œ ìƒíƒœë¡œ ì¼ì‹œì •ì§€
          const rewardText = giveLevelReward(this.level);
          triggerLevelUp(this.level, rewardText);
        }
        updateHUD(this);
      }
      damage(amount){
        const dmg = this.hasArmor ? Math.max(1, amount-1) : amount;
        this.hp -= dmg;
        if(this.hp <= 0){
          this.lives -= 1; this.hp = 3;
          if(this.lives < 0){ game.state='lose'; showLose(); }
        }
        updateHUD(this);
      }
      getAttackHitbox(){
        // ê³µê²© ë²”ìœ„ 3ë°° (ê°•ì²  ì•ë‹¤ë¦¬ ì ìš© í›„ ë°°ìˆ˜)
        const baseReach = this.longArms ? 42 : 26;
        const reach = baseReach * 3;
        const ax = this.dir===1 ? this.x + this.w : this.x - reach;
        return { x: ax, y: this.y - 12, w: reach, h: this.h + 14 };
      }
      step(){
        const left = keys.has('ArrowLeft');
        const right= keys.has('ArrowRight');
        const up   = keys.has('ArrowUp');
        const attack = keys.has('Space') || keys.has(' ');

        if(game.state!=='play'){ return; } // ë ˆë²¨ì—…/ì¹´ìš´íŠ¸ë‹¤ìš´/ì •ì§€ ì‹œ ì…ë ¥ ë¬´íš¨

        const accel = 0.9;
        if(left){ this.vx-=accel; this.dir=-1; }
        if(right){ this.vx+=accel; this.dir= 1; }
        if(up && this.onGround && !this.hasWings){ this.vy=-12.4; this.onGround=false; }
        if(this.hasWings && up){ this.vy = Math.min(this.vy, -3.2); }

        if(attack && this.cool<=0){
          this.cool = 16; this.attackFrames = 10; this.swingAngle = 0;
          performAttack(this);
        }

        // ë¬¼ë¦¬
        this.vy += GRAVITY;
        if(this.onGround) this.vx *= FRICTION;
        this.x += this.vx; this.y += this.vy;
        if(this.y>=GROUND_Y){ this.y=GROUND_Y; this.vy=0; this.onGround=true; }
        if(this.x<WORLD_LEFT){ this.x=WORLD_LEFT; this.vx=0; }
        if(this.x+this.w>WORLD_RIGHT){ this.x=WORLD_RIGHT-this.w; this.vx=0; }

        if(this.cool>0) this.cool--;
        if(this.attackFrames>0){ this.attackFrames--; this.swingAngle += 14; }
      }
      draw(){
        const body = this.isGold ? '#ffd54a' : '#8df28a';
        const edge = this.isGold ? '#b08900' : '#2a6b2d';
        const wing = '#b2f0ff';

        // ê·¸ë¦¼ì
        ctx.fillStyle='rgba(0,0,0,0.25)'; ctx.fillRect(this.x+2, this.y+this.h-4, this.w, 6);

        // ëª¸í†µ
        ctx.fillStyle=body; ctx.strokeStyle=edge; ctx.lineWidth=2;
        ctx.fillRect(this.x, this.y-this.h, this.w, this.h); ctx.strokeRect(this.x, this.y-this.h, this.w, this.h);
        // ë¨¸ë¦¬
        const headW=26, headH=18, hx=this.x+(this.dir===1?6:-2), hy=this.y-this.h-headH+6;
        ctx.fillRect(hx,hy,headW,headH); ctx.strokeRect(hx,hy,headW,headH);
        ctx.fillStyle='#111'; const eyeX=this.dir===1? hx+headW-8 : hx+4; ctx.fillRect(eyeX, hy+6, 5,5);

        // ì¼ë°˜ íŒ”
        ctx.strokeStyle=edge; ctx.beginPath();
        const armLen = this.longArms?22:16; const ax = this.dir===1? this.x+this.w-4 : this.x+4;
        ctx.moveTo(ax, this.y - this.h/2); ctx.lineTo(ax + this.dir*armLen, this.y - this.h/2 - 6); ctx.stroke();

        // ë‚ ê°œ
        if(this.hasWings){ ctx.fillStyle=wing; ctx.globalAlpha=0.8; const wx=this.x+(this.dir===1?-6:6); ctx.fillRect(wx, this.y-this.h-8, 18, 12); ctx.globalAlpha=1; }

        // ê³µê²© ëª¨ì…˜: ë‚ ì¹´ë¡œìš´ íŒ” íœ˜ë‘ë¥´ê¸°
        if(this.attackFrames>0){
          const swingDir = this.dir; const baseX = this.dir===1 ? this.x+this.w : this.x; const baseY = this.y - this.h/2 - 6;
          ctx.save(); ctx.translate(baseX, baseY); ctx.rotate((Math.PI/180) * this.swingAngle * swingDir); ctx.translate(-baseX, -baseY);
          const tipX = baseX + swingDir*34;
          ctx.beginPath(); ctx.moveTo(baseX, baseY); ctx.lineTo(tipX, baseY-10); ctx.lineTo(tipX, baseY+10); ctx.closePath();
          ctx.fillStyle = this.isGold? '#ffe082' : '#caffad'; ctx.strokeStyle = this.isGold? '#b08900' : '#5fbf62'; ctx.lineWidth = 2; ctx.fill(); ctx.stroke();
          ctx.restore();
          // íˆíŠ¸ë°•ìŠ¤ ê°€ì´ë“œ(ì–‡ì€ íŒŒì„ )
          const hb = this.getAttackHitbox(); ctx.strokeStyle = this.isGold? '#ffe082' : '#7ee081'; ctx.setLineDash([6,4]); ctx.strokeRect(hb.x, hb.y, hb.w, hb.h); ctx.setLineDash([]);
        }
      }
    }

    // ===== ì  =====
    class Enemy{
      constructor(level,type){
        this.level=level; this.type=type; this.dir=-1;
        // ì™¸í˜•/ëŠ¥ë ¥
        if(type==='boss'){ this.w=160; this.h=120; this.hp=10; this.speed=1.2; this.score=0; this.name=LEVEL_ENEMY_NAME[5]; }
        else if(type==='super'){ this.w=70; this.h=56; this.hp=5; this.speed=1.8; this.score=20; this.name=`ìŠˆí¼ ${LEVEL_ENEMY_NAME[level]}`; }
        else { this.w=34 + (level-1)*2; this.h=26 + (level-1)*2; this.hp=1; this.speed=2.0 + level*0.35; this.score=5; this.name=LEVEL_ENEMY_NAME[level]; }
        this.x=canvas.width + rnd(0, 120); this.y=GROUND_Y;
        this.hitFlash=0; this.dead=false; this.kb=0; // ë…¸í¬ë°± í”„ë ˆì„
      }
      step(){
        if(game.state!=='play'){ return; }
        // ë…¸í¬ë°± ìƒíƒœë©´ ì˜¤ë¥¸ìª½(ë’¤)ìœ¼ë¡œ ë°€ë ¤ë‚¨
        if(this.kb>0){ this.x += 4; this.kb--; }
        else { this.x -= this.speed; }
        if(this.x + this.w < 0) this.dead = true;
      }
      draw(){
        // ë ˆë²¨ë³„ ì™¸í˜• ë³€ì£¼: ìƒ‰, ë¬´ëŠ¬, ë”ë“¬ì´/ë“±ë¬´ëŠ¬
        const levelColor = {
          1: ['#9be7ff','#123e4a'],
          2: ['#ffd0a0','#5a3b10'],
          3: ['#ffb3c1','#5a1e2a'],
          4: ['#c9ff8f','#2d5a1e'],
          5: ['#ff9e80','#5a1e10']
        };
        const [base, edge] = (this.type==='super') ? ['#ffd54a','#6b5200'] : (this.type==='boss' ? ['#ff9e80','#5a1e10'] : levelColor[this.level]);
        const fill = (this.hitFlash>0)? '#ffffff' : base; if(this.hitFlash>0) this.hitFlash--;

        // ëª¸í†µ
        ctx.fillStyle=fill; ctx.strokeStyle=edge; ctx.lineWidth=2;
        ctx.fillRect(this.x, this.y-this.h, this.w, this.h); ctx.strokeRect(this.x, this.y-this.h, this.w, this.h);

        // ë ˆë²¨ì— ë”°ë¥¸ ì¥ì‹: ì¤„ë¬´ëŠ¬/ì , ë”ë“¬ì´
        ctx.fillStyle=edge;
        if(this.level>=2 && this.type!=='boss'){
          // ì¤„ë¬´ëŠ¬
          for(let i=6;i<this.w-6;i+=12){ ctx.fillRect(this.x+i, this.y-this.h+6, 6, 4); }
        }
        if(this.level>=3 && this.type!=='boss'){
          // ë“±ì ë¬´ëŠ¬
          for(let i=8;i<this.w-8;i+=16){ ctx.fillRect(this.x+i, this.y-this.h+this.h/2, 4,4); }
        }
        if(this.level>=4 || this.type==='super'){
          // ë”ë“¬ì´
          ctx.strokeStyle=edge; ctx.beginPath(); ctx.moveTo(this.x+6, this.y-this.h); ctx.lineTo(this.x-4, this.y-this.h-10); ctx.moveTo(this.x+this.w-6, this.y-this.h); ctx.lineTo(this.x+this.w+4, this.y-this.h-12); ctx.stroke();
        }

        // ëˆˆ/ì…
        ctx.fillStyle='#111'; ctx.fillRect(this.x+6, this.y - this.h + 8, 6, 6); ctx.fillRect(this.x+this.w-12, this.y - this.h + 8, 6, 6); ctx.fillRect(this.x+this.w/2-6, this.y-16, 12, 4);

        // ì´ë¦„ ë¼ë²¨
        ctx.fillStyle='rgba(255,255,255,0.85)'; ctx.font='12px monospace'; ctx.fillText(this.name, this.x, this.y - this.h - 6);
      }
    }

    // ===== ì „íˆ¬/ìŠ¤í° =====
    function performAttack(player){
      const hb = player.getAttackHitbox();
      enemies.forEach(e => {
        if(e.dead) return;
        if(rectHit(hb, {x:e.x, y:e.y - e.h, w:e.w, h:e.h})){
          e.hp -= 1; e.hitFlash = 3; e.kb = 8; // â˜… í”¼í•´ ì‹œ ë…¸í¬ë°± 8í”„ë ˆì„
          if(e.hp <= 0){
            e.dead = true;
            if(e.type === 'boss'){ triggerWin(); } else { player.addScore(e.score); }
          }
        }
      });
    }

    function rectHit(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

    // ê²Œì„ ìƒíƒœ
    const game = { state:'countdown', t:0, countdown:10, storyIndex:0, levelUpTimer:0 };

    const player = new Player();
    let enemies = [];
    let spawnTimer = 0;

    function resetGame(){
      game.state='countdown'; game.countdown=10; game.storyIndex=0; game.t=0; game.levelUpTimer=0;
      player.reset(); enemies=[];
      overlay.style.display='flex'; levelUpOverlay.style.display='none'; winBanner.style.display='none'; loseBanner.style.display='none';
      updateHUD(player);
    }

    function updateHUD(p){ hud.level.textContent=p.level; hud.score.textContent=p.score; hud.lives.textContent=p.lives; hud.hp.textContent=p.hp; hud.items.textContent=p.items.length? p.items.join(', '):'â€”'; }

    // ë ˆë²¨ ë³´ìƒ + í…ìŠ¤íŠ¸ ë°˜í™˜
    function giveLevelReward(level){
      let text = '';
      if(level===2){ player.hasArmor=true; player.items.push('ê°‘ì˜·'); text='ë ˆë²¨ 2 ë‹¬ì„±! ë³´ìƒ: ê°‘ì˜· â€” ë°›ëŠ” í”¼í•´ ê°ì†Œ'; }
      if(level===3){ player.longArms=true; player.items.push('ê°•ì²  ì•ë‹¤ë¦¬'); text='ë ˆë²¨ 3 ë‹¬ì„±! ë³´ìƒ: ê°•ì²  ì•ë‹¤ë¦¬ â€” ê³µê²© ì‚¬ê±°ë¦¬ ì¦ê°€'; }
      if(level===4){ player.hasWings=true; player.items.push('ë‚ ê°œ'); text='ë ˆë²¨ 4 ë‹¬ì„±! ë³´ìƒ: ë‚ ê°œ â€” â†‘ ìœ ì§€ë¡œ ë¹„í–‰'; }
      if(level===5){ player.isGold=true; player.items.push('ê¸ˆë¹› ë³€ì‹ '); text='ë ˆë²¨ 5 ëŒì…! ê¸ˆë¹›ìœ¼ë¡œ ë³€ì‹  â€” ë³´ìŠ¤ ì¶œí˜„!'; spawnBoss(); }
      updateHUD(player);
      return text;
    }

    // â˜… ë ˆë²¨ì—… 3ì´ˆ ì—°ì¶œ
    function triggerLevelUp(level, text){
      levelUpText.textContent = text || `ë ˆë²¨ ${level} ë‹¬ì„±!`;
      levelUpOverlay.style.display = 'flex';
      // 3ì´ˆê°„ ì¼ì‹œì •ì§€
      game.state = 'levelup';
      game.levelUpTimer = 180; // 60fps ê¸°ì¤€ 3ì´ˆ
    }

    function spawnBoss(){ enemies = enemies.filter(e=>e.type==='boss'); enemies.push(new Enemy(5,'boss')); }

    function spawnEnemies(){
      if(player.level>=5) return;
      if(game.state!=='play') return; // ì¹´ìš´íŠ¸ë‹¤ìš´/ë ˆë²¨ì—… ì¤‘ì—” ìŠ¤í° ì¤‘ì§€
      spawnTimer -= 1;
      if(spawnTimer<=0){
        const type = Math.random()<0.14 ? 'super' : 'normal';
        enemies.push(new Enemy(player.level, type));
        // ìŠ¤í° ê°„ê²©ì„ ê¸¸ê²Œ
        const base = 110 - player.level*4;
        spawnTimer = Math.max(36, base + Math.floor(rnd(-18, 18)));
      }
    }

    // ìŠ¤í† ë¦¬ ë¼ì¸
    const storyLines=[
      'ì•„ê¸° ì‚¬ë§ˆê·€ì˜ ì—¬ì •ì´ ê³§ ì‹œì‘ë©ë‹ˆë‹¤â€¦',
      'ë‹¤ê°€ì˜¤ëŠ” ì•…ë‹¹ ê³¤ì¶©ì„ ë¬¼ë¦¬ì¹˜ì„¸ìš”!',
      'ì¼ë°˜ ì ì€ 1íƒ€, ìŠˆí¼ ì ì€ 5íƒ€ í•„ìš”!',
      '100ì ì„ ëª¨ìœ¼ë©´ ë ˆë²¨ì—… & ì•„ì´í…œ íšë“!',
      'ë ˆë²¨4ì—” ë‚ ê°œë¡œ ë¹„í–‰ ê°€ëŠ¥!',
      'ë ˆë²¨5, ë³´ìŠ¤ ë¼ì§€ì—¬ì¹˜ì™€ì˜ ìµœì¢… ê²°ì „!'
    ];

    // ìŠ¹íŒ¨
    function triggerWin(){ game.state='win'; winBanner.style.display='flex'; }
    function showLose(){ loseBanner.style.display='flex'; }

    restartWin.addEventListener('click', resetGame);
    restartLose.addEventListener('click', resetGame);

    // ë‹¨ì¶•í‚¤
    window.addEventListener('keydown', (e)=>{
      if(e.key==='p'||e.key==='P'){ if(game.state==='play') game.state='pause'; else if(game.state==='pause') game.state='play'; }
      if(e.key==='r'||e.key==='R') resetGame();
    });

    // ===== ë£¨í”„ =====
    function loop(){
      requestAnimationFrame(loop);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawBackground();

      // ì¹´ìš´íŠ¸ë‹¤ìš´
      if(game.state==='countdown'){
        game.t++;
        if(game.t%60===0 && game.countdown>0){ game.countdown--; countEl.textContent=game.countdown; game.storyIndex=(game.storyIndex+1)%storyLines.length; storyEl.textContent=storyLines[game.storyIndex]; }
        if(game.countdown<=0){ game.state='play'; overlay.style.display='none'; }
        player.draw();
        return;
      }

      // ë ˆë²¨ì—… ì—°ì¶œ: 3ì´ˆ ì •ì§€
      if(game.state==='levelup'){
        drawWorld();
        if(game.levelUpTimer>0){ game.levelUpTimer--; }
        else { levelUpOverlay.style.display='none'; game.state='play'; }
        return;
      }

      // ì¼ì‹œì •ì§€
      if(game.state==='pause'){ drawWorld(); drawCenterText('ì¼ì‹œì •ì§€', '#ffd54a'); return; }

      // ìŠ¹íŒ¨ í›„
      if(game.state==='win' || game.state==='lose'){ drawWorld(); return; }

      // ì‹¤ì œ í”Œë ˆì´
      if(game.state==='play'){
        player.step();
        spawnEnemies();
        enemies.forEach(e=> e.step());
        enemies = enemies.filter(e=>!e.dead);

        // ì ‘ì´‰ í”¼í•´
        enemies.forEach(e=>{
          const a={x:player.x,y:player.y-player.h,w:player.w,h:player.h};
          const b={x:e.x,y:e.y-e.h,w:e.w,h:e.h};
          if(rectHit(a,b)){
            player.damage(1);
            player.vx += -player.dir*3; player.vy=-6; player.onGround=false;
          }
        });

        drawWorld();
        return;
      }
    }

    // ===== ë Œë”ë§ =====
    function drawBackground(){
      for(let i=0;i<canvas.height;i+=8){ const t=i/canvas.height; const c=16+Math.floor(40*t); ctx.fillStyle=`rgb(${c}, ${c+8}, ${c+24})`; ctx.fillRect(0,i,canvas.width,8);} 
      ctx.fillStyle='#0f1a1a';
      for(let x=0;x<canvas.width;x+=80){ const h=80+Math.sin((x+game.t*0.02)*0.02)*20; ctx.fillRect(x,canvas.height-200,60,h); }
      ctx.fillStyle='#1f2d1f'; ctx.fillRect(0,GROUND_Y+8,canvas.width,80); ctx.fillStyle='#233523'; for(let x=0;x<canvas.width;x+=16){ ctx.fillRect(x,GROUND_Y+8,12,4); }
    }

    function drawWorld(){
      enemies.forEach(e=> e.draw());
      player.draw();
      ctx.strokeStyle='#2a3a2a'; ctx.beginPath(); ctx.moveTo(0,GROUND_Y+0.5); ctx.lineTo(canvas.width,GROUND_Y+0.5); ctx.stroke();
    }

    function drawCenterText(text,color){ ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(canvas.width/2-160,canvas.height/2-60,320,120); ctx.strokeStyle='#333'; ctx.strokeRect(canvas.width/2-160,canvas.height/2-60,320,120); ctx.fillStyle=color; ctx.font='28px monospace'; ctx.textAlign='center'; ctx.fillText(text, canvas.width/2, canvas.height/2+10); ctx.textAlign='start'; }

    // ì‹œì‘
    resetGame();
    loop();
  </script>
</body>
</html>
