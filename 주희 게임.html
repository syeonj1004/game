<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í¬ì£¼ ê²Œì„ â€” ê³¼ì¼ ë¨¹ê¸° ìŠˆíŒ…</title>
  <style>
    /* ===== ê¸°ë³¸ ë ˆì´ì•„ì›ƒ & ìŠ¤íƒ€ì¼ ===== */
    :root {
      --bg: #0f172a;        /* í˜ì´ì§€ ë°°ê²½ (ìŠ¬ë ˆì´íŠ¸ ë‚¨ìƒ‰) */
      --panel: #111827;     /* ì¹´ë“œ ë°°ê²½ */
      --acc: #22d3ee;       /* í¬ì¸íŠ¸ ìƒ‰ */
      --text: #e5e7eb;      /* ë³¸ë¬¸ í…ìŠ¤íŠ¸ */
      --muted: #9ca3af;     /* ì„œë¸Œ í…ìŠ¤íŠ¸ */
      --win: #22c55e;
      --lose: #ef4444;
    }
    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      background: radial-gradient(60% 60% at 50% 40%, #111827, var(--bg));
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif;
      display: grid;
      place-items: center;
    }

    .wrap {
      width: min(980px, 94vw);
    }
    h1 {
      text-align: center;
      letter-spacing: 0.02em;
      margin: 20px 0 10px;
    }
    .card {
      background: linear-gradient(180deg, #0b1220, var(--panel));
      border: 1px solid #1f2937;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    /* ìƒë‹¨ HUD */
    .hud {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #0b1220;
      border: 1px solid #1f2937;
    }
    .stat { font-weight: 600; }
    .badge { padding: 6px 10px; border-radius: 999px; background: #0d1322; border: 1px solid #1f2937; color: var(--muted); }
    .btn { cursor: pointer; padding: 8px 14px; border-radius: 10px; border: 1px solid #1f2937; background: #0d1322; color: var(--text); font-weight: 700; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }

    /* ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ */
    .stage {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid #1f2937;
      background: #ffffff; /* âœ… ìš”êµ¬ì‚¬í•­: ìº”ë²„ìŠ¤ ë°•ìŠ¤(ë°°ê²½)ì„ í°ìƒ‰ìœ¼ë¡œ */
      display: grid;
      place-items: center;
    }
    canvas { display: block; width: 100%; height: auto; }

    /* ì‹œì‘ í™”ë©´ (ì»´í“¨í„° ì´ë¯¸ì§€ ë²„íŠ¼) */
    .start-screen {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(15, 23, 42, 0.86);
      backdrop-filter: blur(2px);
      z-index: 10;
    }
    .start-card {
      background: #0b1220;
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 22px 20px 14px;
      text-align: center;
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
      max-width: 520px;
    }
    .start-card h2 { margin: 0 0 10px; }
    .start-tip { color: var(--muted); font-size: 14px; margin-top: 6px; }
    .computer-btn { margin-top: 10px; cursor: pointer; border: none; background: transparent; }
    .computer-btn:focus { outline: 2px solid var(--acc); border-radius: 8px; }

    /* ê²°ê³¼ ì˜¤ë²„ë ˆì´ */
    .overlay {
      position: absolute; inset: 0; display: none; place-items: center;
      background: rgba(15,23,42,.88); z-index: 12; backdrop-filter: blur(2px);
    }
    .overlay.show { display: grid; }
    .result {
      background: #0b1220; border: 1px solid #1f2937; border-radius: 16px;
      padding: 22px; text-align: center; max-width: 420px;
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
    }
    .result h3 { margin: 6px 0 2px; }
    .result .msg { color: var(--muted); margin-bottom: 12px; }

    /* ë ˆë²¨ì—… í† ìŠ¤íŠ¸ */
    .toast { position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
      padding: 8px 14px; border-radius: 999px; background: #ecfeff; color: #0c4a6e;
      border: 1px solid #bae6fd; font-weight: 800; display: none; z-index: 11;
      box-shadow: 0 6px 18px rgba(0,0,0,.22);
    }
    .toast.show { display: inline-block; animation: pop .9s ease both; }
    @keyframes pop { 0% { transform: translate(-50%, -10px) scale(.9); opacity: 0 } 20% { opacity: 1 } 70% { transform: translate(-50%, 0) scale(1.02)} 100% { transform: translate(-50%, 0) scale(1)} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ® í¬ì£¼ ê²Œì„ â€” ê³¼ì¼ ë¨¹ê¸° ìŠˆíŒ…</h1>

    <div class="card">
      <!-- ìƒë‹¨ HUD -->
      <div class="hud">
        <div class="stat">ëª©í‘œ ê³¼ì¼: <strong id="goal">20</strong>ê°œ</div>
        <div class="badge">ì ìˆ˜: <strong id="score">0</strong></div>
        <div class="badge">ìˆ˜ì§‘: <strong id="collected">0</strong>ê°œ</div>
        <button id="restartBtn" class="btn" disabled>ë‹¤ì‹œ ì‹œì‘</button>
      </div>

      <!-- ê²Œì„ ìŠ¤í…Œì´ì§€ -->
      <div class="stage" style="aspect-ratio: 16/9;">
        <canvas id="game" width="960" height="540" aria-label="í¬ì£¼ ê²Œì„ ìº”ë²„ìŠ¤"></canvas>

        <!-- ë ˆë²¨ì—… í† ìŠ¤íŠ¸ -->
        <div class="toast" id="toast">LEVEL UP!</div>

        <!-- ì‹œì‘ í™”ë©´ (ì»´í“¨í„° ì´ë¯¸ì§€ í´ë¦­ ì‹œ ì‹œì‘) -->
        <div id="start" class="start-screen" role="dialog" aria-modal="true">
          <div class="start-card">
            <h2>ì»´í“¨í„°ë¥¼ í´ë¦­í•´ì„œ ì‹œì‘!</h2>
            <div class="start-tip">ë°©í–¥í‚¤ë¡œ ì²­ì†Œë…„ ìºë¦­í„°ë¥¼ ì›€ì§ì—¬ ê³¼ì¼(ğŸğŸŒğŸ‡ğŸ“ ë“±)ì„ ë¨¹ìœ¼ì„¸ìš”.<br>ë²½(ì¥ì• ë¬¼)ì— ë¶€ë”ªíˆë©´ ê²Œì„ ì˜¤ë²„, ê³¼ì¼ì„ ë§ì´ ë¨¹ìœ¼ë©´ ë ˆë²¨ì´ ì˜¬ë¼ê°€ìš”.</div>
            <button id="startBtn" class="computer-btn" aria-label="ê²Œì„ ì‹œì‘">
              <!-- âœ… ì™¸ë¶€ íŒŒì¼ ì—†ì´ ë™ì‘í•˜ëŠ” ì»´í“¨í„° SVG ì•„ì´ì½˜ -->
              <svg width="160" height="120" viewBox="0 0 160 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="10" y="12" width="140" height="86" rx="10" fill="#0ea5e9" stroke="#38bdf8" stroke-width="4"/>
                <rect x="20" y="22" width="120" height="60" rx="6" fill="#111827"/>
                <rect x="55" y="88" width="50" height="8" rx="4" fill="#94a3b8"/>
                <rect x="40" y="98" width="80" height="10" rx="5" fill="#cbd5e1"/>
              </svg>
            </button>
            <div class="start-tip">âš ï¸ ê³¼ì¼ 20ê°œë¥¼ ëª¨ìœ¼ë©´ ìŠ¹ë¦¬í•©ë‹ˆë‹¤. (ê°œìˆ˜ëŠ” ì½”ë“œ ìƒë‹¨ì—ì„œ ì‰½ê²Œ ë³€ê²½ ê°€ëŠ¥)</div>
          </div>
        </div>

        <!-- ê²°ê³¼ ì˜¤ë²„ë ˆì´ (ìŠ¹/íŒ¨ ê³µìš©) -->
        <div id="overlay" class="overlay">
          <div class="result" id="resultBox">
            <div id="resultEmoji" style="font-size:44px;">ğŸ‰</div>
            <h3 id="resultTitle">ìŠ¹ë¦¬!</h3>
            <div class="msg" id="resultMsg">ìˆ˜ê³ í–ˆì–´ìš”! ë ˆë²¨ì—…ì„ ê±°ë“­í•˜ë©° ëª©í‘œë¥¼ ë‹¬ì„±í–ˆì–´ìš”.</div>
            <button id="againBtn" class="btn" style="margin-top:10px;">ë‹¤ì‹œ í•˜ê¸°</button>
          </div>
        </div>
      </div>
    </div>

    <p style="text-align:center; color: var(--muted); margin: 10px 0 0; font-size: 14px;">ì¡°ì‘: ë°©í–¥í‚¤ â† â†‘ â†’ â†“ Â· ì‹œì‘: ì»´í“¨í„° í´ë¦­ Â· ì†Œë¦¬: ì—†ìŒ</p>
  </div>

  <script>
    // ==========================
    //  í¬ì£¼ ê²Œì„ ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸
    //  - ìš”êµ¬ì‚¬í•­ ìš”ì•½ -
    //   â€¢ ì‹œì‘ ì¡°ê±´: ì»´í“¨í„°(ì´ë¯¸ì§€) í´ë¦­
    //   â€¢ ì¡°ì‘: ë°©í–¥í‚¤
    //   â€¢ ëª©í‘œ: ê³¼ì¼ ë§ì´ ë¨¹ê¸° (ìˆ˜ì§‘ ê°œìˆ˜ ë„ë‹¬ ì‹œ ìŠ¹ë¦¬)
    //   â€¢ ì ìˆ˜: ê³¼ì¼ 1ê°œë§ˆë‹¤ 5ì 
    //   â€¢ ê²Œì„ ì˜¤ë²„: ë²½(ì¥ì• ë¬¼)ê³¼ ì¶©ëŒ
    //   â€¢ ë‚œì´ë„: ë ˆë²¨ì´ ì˜¤ë¥¼ìˆ˜ë¡ ì†ë„/ë¹ˆë„ ì¦ê°€ + LEVEL UP í‘œì‹œ
    //   â€¢ ê³¼ì¼/ìºë¦­í„°ëŠ” ì´ëª¨ì§€ ì‚¬ìš©, ìº”ë²„ìŠ¤ ë°°ê²½ì€ í°ìƒ‰
    // ==========================

    // ====== ì„¤ì •ê°’ (í•„ìš”ì‹œ ì—¬ê¸°ë§Œ ìˆ˜ì •) ======
    const GOAL_FRUITS = 20;             // âœ… ìŠ¹ë¦¬ ì¡°ê±´: ìˆ˜ì§‘í•´ì•¼ í•  ê³¼ì¼ ê°œìˆ˜
    const FRUIT_SCORE = 5;              // âœ… ê³¼ì¼ 1ê°œë‹¹ ì ìˆ˜
    const BASE_PLAYER_SPEED = 3.2;      // í”Œë ˆì´ì–´ ê¸°ë³¸ ì†ë„ (px/frame)
    const BASE_FRUIT_SPAWN_MS = 900;    // ê³¼ì¼ ìƒì„± ì£¼ê¸°(ë‚®ì„ìˆ˜ë¡ ìì£¼ ìƒì„±)
    const BASE_FRUIT_SPEED = 1.2;       // ê³¼ì¼ ì´ë™ ì†ë„
    const BASE_WALL_SPEED = 0.8;        // ë²½ ì´ë™ ì†ë„
    const FRUITS_PER_LEVEL = 5;         // ë ˆë²¨ì—… ê¸°ì¤€ (ìˆ˜ì§‘ nê°œë§ˆë‹¤ ë ˆë²¨ +1)

    // ====== ìº”ë²„ìŠ¤/ì»¨í…ìŠ¤íŠ¸ ======
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    // ê³ í•´ìƒë„ ë””ìŠ¤í”Œë ˆì´ ìŠ¤ì¼€ì¼ ëŒ€ì‘
    function fixDPR() {
      const ratio = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
      const { width, height } = canvas;
      canvas.width = width * ratio;
      canvas.height = height * ratio;
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
    }
    fixDPR();
    window.addEventListener('resize', fixDPR);

    // ====== DOM ì°¸ì¡° ======
    const elScore = document.getElementById('score');
    const elCollected = document.getElementById('collected');
    const elGoal = document.getElementById('goal');
    const startScreen = document.getElementById('start');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const overlay = document.getElementById('overlay');
    const againBtn = document.getElementById('againBtn');
    const resultTitle = document.getElementById('resultTitle');
    const resultMsg = document.getElementById('resultMsg');
    const resultEmoji = document.getElementById('resultEmoji');
    const toast = document.getElementById('toast');

    elGoal.textContent = GOAL_FRUITS;

    // ====== ê²Œì„ ìƒíƒœ ======
    const state = {
      running: false,
      over: false,
      level: 1,
      score: 0,
      collected: 0,
      keys: new Set(),
      lastSpawn: 0,
      rngSeed: Math.random()*1e9,
    };

    // ê°„ë‹¨í•œ RNG (ì‹œë“œ ê³ ì • ê°€ëŠ¥)
    function rand() {
      state.rngSeed ^= state.rngSeed << 13; state.rngSeed ^= state.rngSeed >> 17; state.rngSeed ^= state.rngSeed << 5;
      return Math.abs(state.rngSeed) / 2**31;
    }

    // ì´ëª¨ì§€ ë¦¬ì†ŒìŠ¤
    const FRUITS = ['ğŸ','ğŸŒ','ğŸ‡','ğŸ“','ğŸŠ','ğŸ','ğŸ','ğŸ¥'];
    const PLAYER_EMOJI = 'ğŸ§‘'; // ì²­ì†Œë…„ ëŠë‚Œ ì´ëª¨ì§€

    // ì—”í‹°í‹° ì»¨í…Œì´ë„ˆ
    const player = { x: 120, y: 120, size: 28 };
    /** ê³¼ì¼: {x, y, vx, vy, size, emoji} */
    const fruits = [];
    /** ë²½(ì¥ì• ë¬¼): {x, y, w, h, vx, vy}  - ë²½ê³¼ ë¶€ë”ªíˆë©´ ê²Œì„ ì˜¤ë²„ */
    const walls = [];

    // ì´ˆê¸° ë²½ ìƒì„± (ìº”ë²„ìŠ¤ ì¤‘ì•™ ê·¼ì²˜ì— ëª‡ ê°œ ë°°ì¹˜, ì¢Œìš°/ìƒí•˜ë¡œ ì™•ë³µ ì´ë™)
    function setupWalls() {
      walls.length = 0;
      const ws = 18; // ë²½ ë‘ê»˜
      const W = canvas.width / (window.devicePixelRatio||1);
      const H = canvas.height / (window.devicePixelRatio||1);
      // ìˆ˜í‰ ë²½ 2ê°œ
      walls.push({ x: W*0.18, y: H*0.40, w: W*0.64, h: ws, vx: BASE_WALL_SPEED, vy: 0 });
      walls.push({ x: W*0.10, y: H*0.70, w: W*0.58, h: ws, vx: -BASE_WALL_SPEED, vy: 0 });
      // ìˆ˜ì§ ë²½ 2ê°œ
      walls.push({ x: W*0.35, y: H*0.18, w: ws, h: H*0.42, vx: 0, vy: BASE_WALL_SPEED });
      walls.push({ x: W*0.70, y: H*0.10, w: ws, h: H*0.50, vx: 0, vy: -BASE_WALL_SPEED });
    }

    // ë ˆë²¨ì— ë”°ë¥¸ ì†ë„ ë³´ì •
    function levelScale(base) {
      return base * (1 + (state.level-1)*0.18);
    }

    // ê³¼ì¼ ìƒì„±
    function spawnFruit() {
      const W = canvas.width / (window.devicePixelRatio||1);
      const H = canvas.height / (window.devicePixelRatio||1);
      const pad = 24;
      // í”Œë ˆì´ì–´ì™€ ë„ˆë¬´ ê°€ê¹Œìš´ ê³³ì€ í”¼í•´ì„œ ìƒì„±
      let x = pad + rand()*(W - pad*2);
      let y = pad + rand()*(H - pad*2);
      if (Math.hypot(x-player.x, y-player.y) < 80) {
        x = (x + 120) % (W - pad) + pad;
        y = (y + 90) % (H - pad) + pad;
      }
      const angle = rand()*Math.PI*2;
      const speed = levelScale(BASE_FRUIT_SPEED) * (0.6 + rand()*0.8);
      fruits.push({
        x, y,
        vx: Math.cos(angle)*speed,
        vy: Math.sin(angle)*speed,
        size: 28 + rand()*10,
        emoji: FRUITS[(Math.random()*FRUITS.length)|0]
      });
    }

    // ì¶©ëŒ ìœ í‹¸
    function rectsIntersect(ax, ay, aw, ah, bx, by, bw, bh) {
      return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
    }

    // í”Œë ˆì´ì–´ ì´ë™ ì²˜ë¦¬
    function updatePlayer(dt) {
      const speed = levelScale(BASE_PLAYER_SPEED);
      if (state.keys.has('ArrowLeft'))  player.x -= speed;
      if (state.keys.has('ArrowRight')) player.x += speed;
      if (state.keys.has('ArrowUp'))    player.y -= speed;
      if (state.keys.has('ArrowDown'))  player.y += speed;

      // í™”ë©´ ê²½ê³„ ì œí•œ (ë²½ ì¶©ëŒë¡œ ê²Œì„ ì˜¤ë²„ê°€ ì•„ë‹ˆë¼ ê²½ê³„ëŠ” ì§€ë‚˜ê°€ì§€ ëª»í•˜ê²Œë§Œ)
      const W = canvas.width / (window.devicePixelRatio||1);
      const H = canvas.height / (window.devicePixelRatio||1);
      const s = player.size;
      player.x = Math.max(6, Math.min(W - s - 6, player.x));
      player.y = Math.max(6, Math.min(H - s - 6, player.y));
    }

    // ê³¼ì¼ ì´ë™ + ìˆ˜ì§‘ íŒì •
    function updateFruits(dt) {
      const W = canvas.width / (window.devicePixelRatio||1);
      const H = canvas.height / (window.devicePixelRatio||1);
      for (let i = fruits.length - 1; i >= 0; i--) {
        const f = fruits[i];
        f.x += f.vx; f.y += f.vy;
        // ë²½/ê²½ê³„ì— ë¶€ë”ªíˆë©´ ì‚´ì§ íŠ•ê¹€
        if (f.x < 6 || f.x > W - f.size - 6) f.vx *= -1;
        if (f.y < 6 || f.y > H - f.size - 6) f.vy *= -1;
        // í”Œë ˆì´ì–´ ìˆ˜ì§‘ íŒì • (ì´ëª¨ì§€ë¥¼ ì‚¬ê°í˜•ìœ¼ë¡œ ê°„ì£¼)
        if (rectsIntersect(player.x, player.y, player.size, player.size, f.x, f.y, f.size, f.size)) {
          fruits.splice(i, 1);
          state.collected += 1;
          state.score += FRUIT_SCORE;
          elCollected.textContent = state.collected;
          elScore.textContent = state.score;

          // ë ˆë²¨ì—… ì²´í¬
          const newLevel = Math.floor(state.collected / FRUITS_PER_LEVEL) + 1;
          if (newLevel > state.level) {
            state.level = newLevel;
            showToast();
            // ë ˆë²¨ì´ ì˜¤ë¥´ë©´ ê³¼ì¼ì„ ë³´ë„ˆìŠ¤ë¡œ ëª‡ ê°œ ë” ìƒì„±
            for (let k=0;k<2;k++) spawnFruit();
            // ë²½ ì†ë„ë„ ì‚´ì§ ì¦ê°€
            for (const w of walls) { w.vx *= 1.12; w.vy *= 1.12; }
          }

          // ìŠ¹ë¦¬ ì¡°ê±´
          if (state.collected >= GOAL_FRUITS) {
            endGame(true);
            return;
          }
        }
      }
    }

    // ë²½(ì¥ì• ë¬¼) ì´ë™ + ì¶©ëŒ
    function updateWalls(dt) {
      const W = canvas.width / (window.devicePixelRatio||1);
      const H = canvas.height / (window.devicePixelRatio||1);
      for (const w of walls) {
        w.x += w.vx; w.y += w.vy;
        // í™”ë©´ ê°€ì¥ìë¦¬ì—ì„œ ë°˜ì‚¬
        if (w.x <= 0 || w.x + w.w >= W) w.vx *= -1;
        if (w.y <= 0 || w.y + w.h >= H) w.vy *= -1;

        // í”Œë ˆì´ì–´ì™€ ì¶©ëŒí•˜ë©´ ê²Œì„ ì˜¤ë²„
        if (rectsIntersect(player.x, player.y, player.size, player.size, w.x, w.y, w.w, w.h)) {
          endGame(false);
          return;
        }
      }
    }

    // ë Œë”ë§ (í™”ì´íŠ¸ ë°°ê²½ ìœ„ì— ë“œë¡œì‰)
    function draw() {
      const W = canvas.width / (window.devicePixelRatio||1);
      const H = canvas.height / (window.devicePixelRatio||1);

      // ë°°ê²½(í°ìƒ‰) + ê·¸ë¦¬ë“œ ì‚´ì§
      ctx.save();
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, W, H);
      ctx.globalAlpha = 0.05;
      ctx.strokeStyle = '#64748b';
      for (let x = 0; x < W; x += 24) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
      for (let y = 0; y < H; y += 24) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }
      ctx.restore();

      // ë²½(ì¥ì• ë¬¼)
      for (const w of walls) {
        ctx.fillStyle = '#111827';
        ctx.strokeStyle = '#0ea5e9';
        ctx.lineWidth = 2;
        ctx.fillRect(w.x, w.y, w.w, w.h);
        ctx.strokeRect(w.x, w.y, w.w, w.h);
      }

      // ê³¼ì¼ ì´ëª¨ì§€ (ê·¸ë¦¼ì ì¶”ê°€ë¡œ ê°€ì‹œì„± â†‘)
      for (const f of fruits) {
        drawEmoji(f.emoji, f.x, f.y, f.size);
      }

      // í”Œë ˆì´ì–´ (ì²­ì†Œë…„ ì´ëª¨ì§€)
      drawEmoji(PLAYER_EMOJI, player.x, player.y, player.size);

      // HUD in-canvas (ë ˆë²¨ í‘œì‹œ)
      ctx.save();
      ctx.font = 'bold 18px system-ui, Apple SD Gothic Neo, sans-serif';
      ctx.fillStyle = '#0c4a6e';
      ctx.fillText(`LEVEL ${state.level}`, 12, 24);
      ctx.restore();
    }

    // ì´ëª¨ì§€ ë“œë¡œì‰ ë„ìš°ë¯¸: í…ìŠ¤íŠ¸ ê·¸ë¦¼ì + ì¤‘ì•™ ì •ë ¬
    function drawEmoji(char, x, y, size) {
      ctx.save();
      ctx.font = `${size}px Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji, Noto Emoji, sans-serif`;
      ctx.textBaseline = 'top';
      ctx.shadowColor = 'rgba(0,0,0,.25)';
      ctx.shadowBlur = 6;
      ctx.shadowOffsetY = 2;
      ctx.fillText(char, x, y);
      ctx.restore();
    }

    // ë©”ì¸ ë£¨í”„
    let last = 0, rafId = null;
    function loop(ts) {
      if (!state.running) return;
      if (!last) last = ts;
      const dt = Math.min(32, ts - last);
      last = ts;

      // ì£¼ê¸°ì ìœ¼ë¡œ ê³¼ì¼ ìƒì„± (ë ˆë²¨ì´ ì˜¬ë¼ê°€ë©´ ë” ìì£¼ ë“±ì¥)
      if (ts - state.lastSpawn > BASE_FRUIT_SPAWN_MS / (1 + (state.level-1)*0.22)) {
        state.lastSpawn = ts;
        if (fruits.length < 40) spawnFruit();
      }

      updatePlayer(dt);
      updateFruits(dt);
      updateWalls(dt);
      draw();

      rafId = requestAnimationFrame(loop);
    }

    // í† ìŠ¤íŠ¸ (LEVEL UP)
    let toastTimer = null;
    function showToast() {
      toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('show'), 1100);
    }

    // ê²Œì„ ì‹œì‘/ë¦¬ì…‹/ì¢…ë£Œ ê´€ë¦¬
    function startGame() {
      // ìƒíƒœ ì´ˆê¸°í™”
      state.running = true; state.over = false; state.level = 1; state.score = 0; state.collected = 0;
      elScore.textContent = '0'; elCollected.textContent = '0';
      player.x = 120; player.y = 120; player.size = 34; // ì‹œì‘ ì‹œ ì¡°ê¸ˆ ë” í¼ â†’ ê°€ì‹œì„±
      fruits.length = 0; setupWalls();
      startScreen.style.display = 'none'; overlay.classList.remove('show');
      restartBtn.disabled = true;
      cancelAnimationFrame(rafId); last = 0; state.lastSpawn = 0;
      // ì‹œì‘ ì‹œ ê³¼ì¼ ëª‡ ê°œ ë¯¸ë¦¬ ë°°ì¹˜
      for (let i=0;i<6;i++) spawnFruit();
      loop(performance.now());
    }

    function endGame(win) {
      if (state.over) return;
      state.over = true; state.running = false;
      restartBtn.disabled = false;
      cancelAnimationFrame(rafId);
      // ê²°ê³¼ UI
      overlay.classList.add('show');
      if (win) {
        resultEmoji.textContent = 'ğŸ†';
        resultTitle.textContent = 'ìŠ¹ë¦¬!';
        resultTitle.style.color = 'var(--win)';
        resultMsg.textContent = `ê³¼ì¼ ${state.collected}ê°œë¥¼ ëª¨ì•„ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆì–´ìš”. ì ìˆ˜ ${state.score}ì !`;
      } else {
        resultEmoji.textContent = 'ğŸ’¥';
        resultTitle.textContent = 'ê²Œì„ ì˜¤ë²„';
        resultTitle.style.color = 'var(--lose)';
        resultMsg.textContent = `ë²½ì— ì¶©ëŒí–ˆì–´ìš”. ìˆ˜ì§‘ ${state.collected}ê°œ Â· ì ìˆ˜ ${state.score}ì `;
      }
    }

    function resetToTitle() {
      // íƒ€ì´í‹€ í™”ë©´ìœ¼ë¡œ ë³µê·€ (ë‹¤ì‹œ ì‹œì‘ ë²„íŠ¼)
      state.running = false; state.over = false;
      overlay.classList.remove('show');
      startScreen.style.display = 'grid';
    }

    // ====== ì…ë ¥ ì²˜ë¦¬ (ë°©í–¥í‚¤) ======
    window.addEventListener('keydown', (e) => {
      const keys = ['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'];
      if (keys.includes(e.key)) { e.preventDefault(); state.keys.add(e.key); }
      if (e.key === 'Enter' && startScreen.style.display !== 'none') startGame();
    });
    window.addEventListener('keyup', (e) => { state.keys.delete(e.key); });

    // ë²„íŠ¼ ë°”ì¸ë”©
    startBtn.addEventListener('click', startGame);
    againBtn.addEventListener('click', startGame);
    restartBtn.addEventListener('click', resetToTitle);

    // ì ‘ê·¼ì„±: í¬ì»¤ìŠ¤ê°€ ì‹œì‘ ë²„íŠ¼ì— ê°€ë„ë¡
    setTimeout(() => startBtn.focus(), 100);
  </script>
</body>
</html>
