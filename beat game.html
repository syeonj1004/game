<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¦¬ë“¬ê²Œì„ (í´ë¦­ Â· ìŠ¤í˜ì´ìŠ¤)</title>
  <style>
    /* ------ Layout ------ */
    :root{
      --bg:#0b0d12;         /* ì–´ë‘ìš´ ë°°ê²½ */
      --panel:#141923;      /* ì¹´ë“œ ë°°ê²½ */
      --text:#e8ecf1;       /* ê¸°ë³¸ í…ìŠ¤íŠ¸ */
      --muted:#9aa6b2;      /* ë³´ì¡° í…ìŠ¤íŠ¸ */
      --accent:#4ea1ff;     /* íŒŒë€ í¬ì¸íŠ¸ */
      --good:#5bd65b;       /* Great ìƒ‰ */
      --okay:#ffd166;       /* Not Bad ìƒ‰ */
      --bad:#ff6b6b;        /* Bad ìƒ‰ */
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, "ë§‘ì€ ê³ ë”•", Arial, sans-serif;
      display:flex; flex-direction:column; min-height:100svh; align-items:center; gap:18px;
    }
    header{ padding:20px 16px 0; text-align:center }
    h1{ margin:0 0 6px; font-size:clamp(24px,3.6vw,36px); letter-spacing:0.2px }
    .sub{ color:var(--muted); font-size:14px }

    .hud{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
    .card{ background:var(--panel); border:1px solid #1f2633; border-radius:14px; padding:10px 12px; min-width:110px; text-align:center }
    .big{ font-size:20px; font-weight:700 }
    .label{ color:var(--muted); font-size:12px }

    /* ------ Stage (ì„¼í„° ì›) ------ */
    .stage-wrap{ display:grid; place-items:center; flex:1; width:100%; max-width:840px; padding:8px 16px }
    .stage{
      position:relative; width:min(56vmin,480px); aspect-ratio:1/1; display:grid; place-items:center;
    }
    .circle{
      width:70%; aspect-ratio:1/1; border-radius:50%;
      border:6px solid var(--accent); background:transparent; filter:drop-shadow(0 0 14px rgba(78,161,255,.35));
      transform:scale(1); transition:transform .12s ease-out;
    }
    .pulse{ animation:pulse .28s ease-out }
    @keyframes pulse{ from{ transform:scale(.86) } to{ transform:scale(1.08) } }

    /* íŒì • í…ìŠ¤íŠ¸ */
    .judge{ position:absolute; bottom:-28px; left:50%; transform:translateX(-50%);
      font-weight:800; letter-spacing:.4px; text-shadow:0 2px 10px rgba(0,0,0,.35) }
    .judge.great{ color:var(--good) }
    .judge.okay{ color:var(--okay) }
    .judge.bad{ color:var(--bad) }

    /* ------ Controls ------ */
    .controls{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; padding:0 16px 24px }
    button{ border:1px solid #263043; background:#1a2230; color:var(--text); border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:700 }
    button:hover{ filter:brightness(1.1) }
    button:disabled{ opacity:.55; cursor:not-allowed }
    .settings{ background:#121826; border:1px solid #2a3550; margin-top:6px; border-radius:12px; padding:14px; width:min(720px,92vw) }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    input[type="range"]{ width:220px }
    .toggle{ display:flex; align-items:center; gap:8px; color:var(--muted) }

    footer{ color:var(--muted); font-size:12px; padding:0 0 14px }
    .kbd{ padding:2px 6px; border:1px solid #2a3550; border-bottom-width:3px; border-radius:6px; background:#0f1521; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
  </style>
</head>
<body>
  <header>
    <h1>ë¦¬ë“¬ê²Œì„</h1>
    <div class="sub">ë§ˆìš°ìŠ¤ í´ë¦­ ë˜ëŠ” <span class="kbd">Space</span> ë¡œ ë°•ì ë§ì¶”ê¸° â€¢ Great â‰¥ 80%ë©´ í´ë¦¬ì–´</div>
  </header>

  <!-- ì‹¤ì‹œê°„ ì •ë³´ í‘œì‹œ -->
  <section class="hud" aria-label="ìƒíƒœ í‘œì‹œ">
    <div class="card"><div class="label">ì ìˆ˜</div><div id="score" class="big">0</div></div>
    <div class="card"><div class="label">Great%</div><div id="greatPct" class="big">0%</div></div>
    <div class="card"><div class="label">ì§„í–‰</div><div id="progress" class="big">0 / 0</div></div>
    <div class="card"><div class="label">ìƒíƒœ</div><div id="state" class="big">ëŒ€ê¸°</div></div>
  </section>

  <!-- ë©”ì¸ ìŠ¤í…Œì´ì§€: íŒŒë€ ë¼ì¸ì˜ ë™ê·¸ë¼ë¯¸ -->
  <main class="stage-wrap">
    <div class="stage" id="stage" role="button" aria-label="ì›ì„ í´ë¦­í•´ ë°•ì ì…ë ¥">
      <div class="circle" id="circle"></div>
      <div id="judge" class="judge">&nbsp;</div>
    </div>
  </main>

  <!-- ì»¨íŠ¸ë¡¤ëŸ¬ & ì„¤ì • -->
  <section class="controls" aria-label="ê²Œì„ ì»¨íŠ¸ë¡¤">
    <button id="btnStart">ê²Œì„ ì‹œì‘</button>
    <button id="btnPause" disabled>ì¼ì‹œ ì •ì§€</button>
    <button id="btnResume" disabled>ê³„ì†</button>
    <button id="btnRestart" disabled>ì¬ì‹œì‘</button>
  </section>

  <section class="settings" aria-label="ì„¤ì •">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <label for="bpm"><strong>ë°•ì ì†ë„ (BPM)</strong></label>
        <input id="bpm" type="range" min="60" max="200" value="100" step="1" />
        <span id="bpmVal" class="label">100</span>
      </div>
      <label class="toggle"><input type="checkbox" id="soundOn" /> ë¹„í”„ìŒ ì‚¬ìš©</label>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="label">íŒì • ê¸°ì¤€ (Â±ms): Great 80 / Not Bad 150 Â· ê·¸ ì™¸ Bad</div>
    </div>
  </section>

  <footer>ë¼ìš´ë“œ ì¢…ë£Œ ì‹œ Great ë¹„ìœ¨ì´ 80% ì´ìƒì´ë©´ <strong>CLEAR</strong>, ì•„ë‹ˆë©´ ì‹¤íŒ¨ì…ë‹ˆë‹¤.</footer>

  <script>
    // =============================
    // ë¦¬ë“¬ê²Œì„ ë¡œì§ (ìˆœìˆ˜ JS)
    // =============================

    // ì—˜ë¦¬ë¨¼íŠ¸ ì°¸ì¡°
    const circle = document.getElementById('circle');
    const judgeEl = document.getElementById('judge');
    const scoreEl = document.getElementById('score');
    const greatPctEl = document.getElementById('greatPct');
    const progressEl = document.getElementById('progress');
    const stateEl = document.getElementById('state');

    const btnStart = document.getElementById('btnStart');
    const btnPause = document.getElementById('btnPause');
    const btnResume = document.getElementById('btnResume');
    const btnRestart = document.getElementById('btnRestart');

    const bpmSlider = document.getElementById('bpm');
    const bpmVal = document.getElementById('bpmVal');
    const soundOn = document.getElementById('soundOn');

    // íŒì • ìœˆë„(ë°€ë¦¬ì´ˆ)
    const GREAT_MS = 80;     // |Î”t| â‰¤ 80ms
    const OKAY_MS  = 150;    // |Î”t| â‰¤ 150ms

    // í•œ ë¼ìš´ë“œ ë¹„íŠ¸ ìˆ˜
    const TOTAL_BEATS = 32;  // 32ë°•ìœ¼ë¡œ ê°„ë‹¨ ë¼ìš´ë“œ

    // ì ìˆ˜ ë£°
    const SCORE_GREAT = 100;
    const SCORE_OKAY  = 50;
    const SCORE_BAD   = 0;

    // ë‚´ë¶€ ìƒíƒœ
    let bpm = parseInt(bpmSlider.value, 10);
    let interval = 60000 / bpm;   // ms/beat

    let beatTimer = null;         // setInterval í•¸ë“¤
    let startTime = null;         // ë¼ìš´ë“œ ì‹œì‘ ì‹œê°„(ms)
    let pausedAt = null;          // ì¼ì‹œì •ì§€ ì‹œê°
    let pauseAccum = 0;           // ëˆ„ì  ì •ì§€ ì‹œê°„(ë³´ì •)

    let beatIndex = 0;            // 0..TOTAL_BEATS-1 (ì§„í–‰ í‘œì‹œìš©)
    let lastJudgedBeat = -999;    // ê°™ì€ ë°• ì¤‘ë³µ ì…ë ¥ ë°©ì§€

    let score = 0;
    let greatCount = 0;           // Great ëˆ„ì 

    // "ì„±ê³µë¥ ì€ ë–¨ì–´ì§€ì§€ ì•ŠìŒ"ì„ ìœ„í•œ í‘œì‹œìš© í¼ì„¼íŠ¸(ìµœëŒ“ê°’ ìœ ì§€)
    let greatPctShown = 0;        // í™”ë©´ì— í‘œì‹œë˜ëŠ” Great%

    // WebAudio (ë¹„í”„ìŒ)
    let audioCtx = null;
    function beep(){
      if(!soundOn.checked) return;
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.value = 880; // A5
      g.gain.value = 0.06;     // ì‘ì€ ë³¼ë¥¨
      o.connect(g).connect(audioCtx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); }, 70);
    }

    // HUD ì—…ë°ì´íŠ¸ (í‘œì‹œë§Œ ê°±ì‹ )
    function updateHUD(){
      scoreEl.textContent = score;
      // ì§„í–‰ í‘œì‹œ: ì§€ë‚˜ê°„ ë°• ìˆ˜ / ì´ ë°• ìˆ˜
      progressEl.textContent = `${Math.min(beatIndex, TOTAL_BEATS)} / ${TOTAL_BEATS}`;
      // ì„±ê³µë¥ ì€ greatPctShown(ìµœëŒ“ê°’ ëˆ„ì )ìœ¼ë¡œ í‘œì‹œ â†’ Bad/Not Badê°€ ë‚˜ì™€ë„ ë‚´ë ¤ê°€ì§€ ì•ŠìŒ
      greatPctEl.textContent = greatPctShown + '%';
    }

    function setJudge(text, cls){
      judgeEl.textContent = text || '\u00A0';
      judgeEl.className = 'judge' + (cls ? ' ' + cls : '');
    }

    // ë°•ì ì‹œê° ê³„ì‚° (ë³´ì • í¬í•¨)
    function beatTime(i){ return startTime + pauseAccum + i * interval; }

    // ìŠ¤í…Œì´ì§€ ì› ì• ë‹ˆë©”ì´ì…˜
    function pulse(){
      circle.classList.remove('pulse');
      void circle.offsetWidth; // reflow
      circle.classList.add('pulse');
    }

    // ë°•ì ì§„í–‰ ë£¨í”„
    function onBeat(){
      pulse();
      beep();
      beatIndex++;
      updateHUD();
      if(beatIndex >= TOTAL_BEATS){
        endRound();
      }
    }

    // ì…ë ¥ ì²˜ë¦¬ (í´ë¦­/ìŠ¤í˜ì´ìŠ¤)
    function handleInput(){
      if(startTime===null) return;         // ì‹œì‘ ì „ ë¬´ì‹œ
      if(beatIndex >= TOTAL_BEATS) return; // ì¢…ë£Œ í›„ ë¬´ì‹œ

      const now = performance.now();
      const k = Math.round((now - (startTime + pauseAccum)) / interval);
      const nearest = beatTime(k);
      const dt = Math.abs(now - nearest);

      // ê°™ì€ ë°• ì¤‘ë³µ ì…ë ¥ ë°©ì§€
      if(k === lastJudgedBeat) return;
      lastJudgedBeat = k;

      let add = 0; let label = 'Bad'; let cls = 'bad';
      if(dt <= GREAT_MS){
        add = SCORE_GREAT; label = 'Great'; cls = 'great';
        greatCount++;
        // ì„±ê³µë¥ (í‘œì‹œìš©) ê°±ì‹ : ì´ë°• ëŒ€ë¹„ í˜„ì¬ Great%ë¥¼ ê³„ì‚°í•´, ì´ì „ í‘œì‹œê°’ë³´ë‹¤ í¬ë©´ ì˜¬ë¦¼(ì ˆëŒ€ ë‚´ë ¤ê°€ì§€ ì•ŠìŒ)
        const pct = Math.round((greatCount / TOTAL_BEATS) * 100);
        if(pct > greatPctShown) greatPctShown = pct;
      }
      else if(dt <= OKAY_MS){
        add = SCORE_OKAY; label = 'Not Bad'; cls = 'okay';
        // í‘œì‹œ í¼ì„¼íŠ¸ëŠ” ìœ ì§€ â†’ ë‚´ë ¤ê°€ì§€ ì•ŠìŒ
      }
      else {
        add = SCORE_BAD; // í‘œì‹œ í¼ì„¼íŠ¸ ìœ ì§€
      }

      score += add;
      setJudge(label, cls);
      updateHUD();
    }

    // ë¼ìš´ë“œ ì¢…ë£Œ & íŒì •
    function endRound(){
      stopTimer();
      document.removeEventListener('keydown', onKey);
      document.removeEventListener('click', onClickStage, true);

      // ìµœì¢… í¼ì„¼íŠ¸ëŠ” ì‹¤ì œ Great ë¹„ìœ¨ë¡œ í•œ ë²ˆ ê°±ì‹ (ê²°ê³¼ ê³ ì§€ìš©)
      const finalPct = Math.round((greatCount / Math.max(1, TOTAL_BEATS)) * 100);
      greatPctShown = Math.max(greatPctShown, finalPct); // ë‚´ë ¤ê°€ì§€ ì•Šë˜, ë” ë†’ë‹¤ë©´ ë°˜ì˜
      updateHUD();

      const clear = finalPct >= 80; // ê·œì¹™: Great â‰¥ 80%ë©´ í´ë¦¬ì–´
      stateEl.textContent = clear ? 'CLEAR' : 'ì‹¤íŒ¨';
      setJudge(clear ? 'ğŸ‰ CLEAR!' : 'ğŸ˜µ GAME OVER', clear ? 'great' : 'bad');

      // ë²„íŠ¼ ìƒíƒœ
      btnStart.disabled = true;
      btnPause.disabled = true;
      btnResume.disabled = true;
      btnRestart.disabled = false;
    }

    // íƒ€ì´ë¨¸ ì œì–´
    function startTimer(){ if(!beatTimer) beatTimer = setInterval(onBeat, interval); }
    function stopTimer(){ if(beatTimer){ clearInterval(beatTimer); beatTimer = null; } }

    // ì‹œì‘/ì¼ì‹œì •ì§€/ê³„ì†/ì¬ì‹œì‘
    function startGame(){
      // ì´ˆê¸°í™”
      bpm = parseInt(bpmSlider.value, 10);
      interval = 60000 / bpm;
      startTime = performance.now();
      pausedAt = null; pauseAccum = 0;
      beatIndex = 0; lastJudgedBeat = -999;
      score = 0; greatCount = 0; greatPctShown = 0;
      setJudge('READY'); updateHUD(); stateEl.textContent = 'ì§„í–‰ ì¤‘';

      // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ë¦¬ í›„ ì‹œì‘
      stopTimer();
      startTimer();

      // ì…ë ¥ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      document.addEventListener('keydown', onKey);
      document.addEventListener('click', onClickStage, true);

      // ë²„íŠ¼ ìƒíƒœ
      btnStart.disabled = true;
      btnPause.disabled = false;
      btnResume.disabled = true;
      btnRestart.disabled = true;
    }

    function pauseGame(){
      if(startTime===null || pausedAt) return;
      pausedAt = performance.now();
      stopTimer();
      stateEl.textContent = 'ì¼ì‹œ ì •ì§€';
      btnPause.disabled = true; btnResume.disabled = false;
    }

    function resumeGame(){
      if(!pausedAt) return;
      const now = performance.now();
      pauseAccum += (now - pausedAt); // ì •ì§€í•œ ë§Œí¼ ë³´ì •
      pausedAt = null;
      // BPMì´ ë°”ë€Œì—ˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ê°±ì‹ 
      bpm = parseInt(bpmSlider.value, 10);
      interval = 60000 / bpm;
      startTimer();
      stateEl.textContent = 'ì§„í–‰ ì¤‘';
      btnPause.disabled = false; btnResume.disabled = true;
    }

    function restartGame(){
      stopTimer();
      startTime = null; pausedAt = null; pauseAccum = 0;
      beatIndex = 0; lastJudgedBeat = -999; score = 0; greatCount = 0; greatPctShown = 0;
      setJudge('\u00A0'); updateHUD(); stateEl.textContent = 'ëŒ€ê¸°';
      btnStart.disabled = false; btnPause.disabled = true; btnResume.disabled = true; btnRestart.disabled = true;
    }

    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    function onKey(e){
      if(e.code === 'Space'){ e.preventDefault(); handleInput(); }
    }
    function onClickStage(e){
      // ìŠ¤í…Œì´ì§€ ì˜ì—­ í´ë¦­ë§Œ í—ˆìš©
      const stage = document.getElementById('stage');
      if(stage.contains(e.target)) handleInput();
    }

    // ì»¨íŠ¸ë¡¤ ë°”ì¸ë”©
    btnStart.addEventListener('click', startGame);
    btnPause.addEventListener('click', pauseGame);
    btnResume.addEventListener('click', resumeGame);
    btnRestart.addEventListener('click', restartGame);

    // BPM ìŠ¬ë¼ì´ë” UI ë°˜ì˜
    bpmSlider.addEventListener('input', ()=>{
      bpmVal.textContent = bpmSlider.value;
      // ì§„í–‰ ì¤‘ì¼ ë•Œ ì†ë„ ë³€ê²½ ì¦‰ì‹œ ë°˜ì˜
      if(startTime!==null && !pausedAt){
        bpm = parseInt(bpmSlider.value, 10);
        interval = 60000 / bpm;
        stopTimer();
        startTimer();
      }
    });

    // ì´ˆê¸° í‘œì‹œ
    bpmVal.textContent = bpmSlider.value;
    updateHUD();
    setJudge('\u00A0');
  </script>
</body>
</html>
