<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì¬ë¯¸ìˆëŠ” íê²Œì„</title>
  <style>
    /* ====== ì „ì²´ ë ˆì´ì•„ì›ƒ & í…Œë§ˆ ====== */
    :root {
      --bg: #ffffff;            /* í°ìƒ‰ ë°°ê²½ */
      --text: #111;             /* ê¸°ë³¸ í…ìŠ¤íŠ¸ */
      --neon-cyan: #00e5ff;     /* ë„¤ì˜¨ í¬ì¸íŠ¸ 1 */
      --neon-magenta: #ff00d4;  /* ë„¤ì˜¨ í¬ì¸íŠ¸ 2 */
      --neon-yellow: #ffe600;   /* ë„¤ì˜¨ í¬ì¸íŠ¸ 3 */
      --panel: #f6f7fb;         /* ìƒë‹¨ íŒ¨ë„ ë°°ê²½ */
      --border: #e8ebf3;        /* ë³´ë” ë¼ì¸ */
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, Helvetica, Arial, sans-serif;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      min-height: 100vh;
    }

    /* ====== í—¤ë” ====== */
    header {
      text-align: center;
      padding: 24px 12px 10px;
    }
    .title {
      font-weight: 800;
      font-size: clamp(28px, 6vw, 48px);
      letter-spacing: 0.5px;
      display: inline-block;
      position: relative;
    }
    /* ë„¤ì˜¨ í…Œë‘ë¦¬ íš¨ê³¼ */
    .title::after {
      content: "";
      position: absolute;
      inset: 0;
      filter: blur(12px);
      z-index: -1;
      background: radial-gradient(60% 60% at 50% 45%, rgba(0,229,255,0.32), transparent 65%),
                  radial-gradient(60% 60% at 50% 55%, rgba(255,0,212,0.25), transparent 65%);
    }

    /* ====== ì»¨íŠ¸ë¡¤ íŒ¨ë„ ====== */
    .panel {
      width: min(1060px, 94vw);
      margin: 0 auto 10px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr auto auto auto auto auto;
      gap: 10px;
      align-items: center;
    }

    .panel .group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .scoreboard {
      display: flex;
      gap: 16px;
      align-items: baseline;
      font-variant-numeric: tabular-nums;
    }

    .score {
      padding: 8px 12px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid var(--border);
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
      font-size: 18px;
      min-width: 90px;
      text-align: center;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #fff;
      border: 1px dashed var(--border);
      font-size: 13px;
    }

    select, input[type="number"], .btn {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
    }

    .btn {
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 0 rgba(0,0,0,0.06);
      user-select: none;
    }

    .btn:active { transform: translateY(1px); }

    .btn.start { background: #00ffb3; }
    .btn.pause { background: #ffd24d; }
    .btn.reset { background: #ff8a8a; }

    .btn.toggle {
      background: #e8f7ff;
      border: 1px solid #cdefff;
    }

    /* ====== ìº”ë²„ìŠ¤ ë˜í¼ ====== */
    .stage-wrap {
      width: min(1060px, 94vw);
      margin: 8px auto 18px;
      position: relative;
      aspect-ratio: 16/9; /* ë°˜ì‘í˜• ë¹„ìœ¨ */
      background: #ffffff; /* í° ë°°ê²½ */
      border: 2px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }

    canvas { width: 100%; height: 100%; display: block; }

    /* ====== ì˜¤ë²„ë ˆì´(ì‹œì‘/ì¼ì‹œì •ì§€/ê²Œì„ì˜¤ë²„) ====== */
    .overlay {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      background: radial-gradient(70% 70% at 50% 50%, rgba(255,255,255,0.65), rgba(255,255,255,0.15));
      backdrop-filter: blur(3px);
      pointer-events: none;
    }

    .overlay .card {
      pointer-events: auto;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px 22px;
      text-align: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      min-width: min(85%, 520px);
    }
    .overlay h2 { margin: 0 0 8px; font-size: clamp(22px, 3.2vw, 32px); }
    .overlay p { margin: 0 0 14px; }

    .glow {
      filter: drop-shadow(0 0 10px rgba(0,229,255,0.85)) drop-shadow(0 0 16px rgba(255,0,212,0.45));
    }

    footer {
      text-align: center;
      padding: 10px 12px 18px;
      color: #666;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <!-- ====== ì œëª© ====== -->
  <header>
    <div class="title glow">ì¬ë¯¸ìˆëŠ” íê²Œì„</div>
  </header>

  <!-- ====== ìƒë‹¨ íŒ¨ë„ (ì ìˆ˜/ë ˆë²¨/ì¡°ì‘) ====== -->
  <section class="panel" aria-label="ê²Œì„ ì •ë³´ ë° ì¡°ì‘">
    <!-- ì ìˆ˜íŒ -->
    <div class="group scoreboard" role="status" aria-live="polite">
      <div class="score" id="scoreL">LEFT 0</div>
      <div class="score" id="scoreR">RIGHT 0</div>
      <span class="badge" id="levelBadge">LV 1</span>
      <span class="badge" id="speedBadge">SPEED 0</span>
    </div>

    <!-- ëª¨ë“œ ì„ íƒ -->
    <div class="group">
      <label for="mode">ëª¨ë“œ</label>
      <select id="mode" title="ê²Œì„ ëª¨ë“œ ì„ íƒ">
        <option value="pvp">2ì¸ í”Œë ˆì´ (P1 vs P2)</option>
        <option value="ai" selected>ì‹±ê¸€ í”Œë ˆì´ (AI ëŒ€ì „)</option>
      </select>
    </div>

    <!-- ëª©í‘œ ì ìˆ˜ -->
    <div class="group">
      <label for="target">ëª©í‘œ ì ìˆ˜</label>
      <input id="target" type="number" min="1" max="30" step="1" value="10" />
    </div>

    <!-- ì‚¬ìš´ë“œ -->
    <div class="group">
      <button class="btn toggle" id="soundBtn" aria-pressed="true">ğŸ”Š ì‚¬ìš´ë“œ ON</button>
    </div>

    <!-- ì‹œì‘/ì¼ì‹œì •ì§€/ë¦¬ì…‹ -->
    <div class="group">
      <button class="btn start" id="startBtn">â–¶ ì‹œì‘</button>
      <button class="btn pause" id="pauseBtn">â¸ ì¼ì‹œì •ì§€</button>
      <button class="btn reset" id="resetBtn">âŸ² ë¦¬ì…‹</button>
    </div>
  </section>

  <!-- ====== ê²Œì„ ìŠ¤í…Œì´ì§€ ====== -->
  <div class="stage-wrap">
    <canvas id="stage" width="1060" height="596" aria-label="íê²Œì„ ìº”ë²„ìŠ¤" tabindex="0"></canvas>

    <!-- ì‹œì‘/ì¼ì‹œì •ì§€/ê²Œì„ì˜¤ë²„ ì˜¤ë²„ë ˆì´ -->
    <div class="overlay" id="overlay">
      <div class="card">
        <h2 id="overlayTitle">ì‹œì‘í•˜ê¸°</h2>
        <p id="overlayDesc">[â–¶ ì‹œì‘] ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜ ìº”ë²„ìŠ¤ë¥¼ í´ë¦­í•˜ì„¸ìš”.<br>ì¡°ì‘: ì™¼ìª½ <b>W/S</b>, ì˜¤ë¥¸ìª½ <b>â†‘/â†“</b></p>
        <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:8px;">
          <button class="btn start" id="ovStart">â–¶ ì‹œì‘</button>
          <button class="btn" id="ovFocus">ğŸ¯ í¬ì»¤ìŠ¤(í‚¤ ì…ë ¥ í—ˆìš©)</button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    ì¡°ì‘: ì™¼ìª½ í”Œë ˆì´ì–´ W/S Â· ì˜¤ë¥¸ìª½ í”Œë ˆì´ì–´ â†‘/â†“ | ê³µì´ ê³¨ë¼ì¸ì— ë‹¿ìœ¼ë©´ 1ì  | ë¨¼ì € ëª©í‘œ ì ìˆ˜ì— ë„ë‹¬í•˜ë©´ ìŠ¹ë¦¬ | ë¼ìš´ë“œê°€ ì§„í–‰ë ìˆ˜ë¡ ê³µ ì†ë„ ì¦ê°€
  </footer>

  <script>
    // =============================
    //  íê²Œì„ (HTML5 Canvas)
    //  - ì¡°ì‘: ì™¼ìª½ W/S, ì˜¤ë¥¸ìª½ â†‘/â†“
    //  - ì‹œì‘ ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ì‹œì‘
    //  - ëª©í‘œ ì ìˆ˜(ê¸°ë³¸ 10ì ) ì„ ë“ì  ìŠ¹ë¦¬
    //  - ë¼ìš´ë“œ ì§„í–‰ ì‹œ ê³µ ì†ë„ ì¦ê°€
    //  - ì¼ì‹œì •ì§€ / ë¦¬ì…‹ / ì‹±ê¸€(AI)/2P ëª¨ë“œ
    // =============================

    // ----- ìº”ë²„ìŠ¤ & ì»¨í…ìŠ¤íŠ¸ -----
    const canvas = document.getElementById('stage');
    const ctx = canvas.getContext('2d');

    // ë°˜ì‘í˜•: CSSëŠ” í¬ê¸°ë§Œ ì¡°ì ˆ, ì‹¤ì œ ë¡œì§ì€ ë‚´ë¶€ í•´ìƒë„(1060x596) ê¸°ì¤€ìœ¼ë¡œ ë™ì‘

    // ----- UI ìš”ì†Œ -----
    const scoreL = document.getElementById('scoreL');
    const scoreR = document.getElementById('scoreR');
    const levelBadge = document.getElementById('levelBadge');
    const speedBadge = document.getElementById('speedBadge');
    const targetInput = document.getElementById('target');
    const modeSelect = document.getElementById('mode');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const soundBtn = document.getElementById('soundBtn');

    const overlay = document.getElementById('overlay');
    const ovStart = document.getElementById('ovStart');
    const ovFocus = document.getElementById('ovFocus');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlayDesc = document.getElementById('overlayDesc');

    // ----- ê²Œì„ ìƒíƒœ -----
    const STATE = {
      Idle: 'idle',
      Playing: 'playing',
      Paused: 'paused',
      Over: 'over',
    };

    let state = STATE.Idle;

    // ----- ê¸°ë³¸ ì„¤ì • -----
    const PADDLE_W = 16;      // íŒ¨ë“¤ ë„ˆë¹„
    const PADDLE_H = 100;     // íŒ¨ë“¤ ë†’ì´(ê¸°ë³¸)
    const PADDLE_SPEED = 8;   // íŒ¨ë“¤ ì´ë™ ì†ë„

    const BALL_SIZE = 14;     // ê³µ í¬ê¸°
    const BALL_SPEED_BASE = 6;// ê¸°ë³¸ ê³µ ì†ë„

    const WALL_THICK = 12;    // ìƒ/í•˜ ê²½ê³„ ë‘ê»˜

    // ë„¤ì˜¨ ê·¸ë¼ë°ì´ì…˜ ìƒ‰ìƒ
    const C_CYAN = '#00e5ff';
    const C_MAG = '#ff00d4';
    const C_YEL = '#ffe600';

    // ì ìˆ˜
    let scoreLeft = 0;
    let scoreRight = 0;

    // ë¼ìš´ë“œ/ë ˆë²¨: ì´ ë“ì  ìˆ˜ì— ë”°ë¼ ì¦ê°€
    let level = 1; // í™”ë©´ í‘œê¸°ìš© ë ˆë²¨

    // ì‚¬ìš´ë“œ ON/OFF
    let soundOn = true;

    // ì‹±ê¸€/2P ëª¨ë“œ
    let singleMode = true; // trueë©´ ì˜¤ë¥¸ìª½ì´ AI

    // ê³µ, íŒ¨ë“¤, í‚¤ ì…ë ¥ ìƒíƒœ
    const leftPaddle = { x: 40, y: canvas.height/2 - PADDLE_H/2, w: PADDLE_W, h: PADDLE_H };
    const rightPaddle = { x: canvas.width - 40 - PADDLE_W, y: canvas.height/2 - PADDLE_H/2, w: PADDLE_W, h: PADDLE_H };

    const ball = { x: canvas.width/2, y: canvas.height/2, vx: 0, vy: 0, size: BALL_SIZE, speed: BALL_SPEED_BASE };

    const keys = { w: false, s: false, up: false, down: false };

    // AI íŒŒë¼ë¯¸í„°
    let aiMaxSpeed = 6;      // AI íŒ¨ë“¤ì´ í•œ í”„ë ˆì„ì— ì´ë™ ê°€ëŠ¥í•œ ìµœëŒ€ ì†ë„
    let aiLag = 0.12;        // ê³µ ì¶”ì  ë³´ì • (ë‚®ì„ìˆ˜ë¡ ì˜ˆì¸¡ ì •í™•)

    // ì• ë‹ˆë©”ì´ì…˜ í•¸ë“¤
    let rafId = null;

    // =============================
    // ì˜¤ë””ì˜¤ (ê°„ë‹¨ íš¨ê³¼ìŒ - ì›¹ì˜¤ë””ì˜¤)
    // =============================
    let audioCtx = null;
    function ensureAudio() {
      if (!audioCtx) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
      }
    }

    function beep(freq = 440, duration = 0.06, type = 'sine', gain = 0.03) {
      if (!soundOn) return;
      ensureAudio();
      const t = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, t);
      g.gain.value = gain;
      osc.connect(g).connect(audioCtx.destination);
      osc.start(t);
      osc.stop(t + duration);
    }

    const sfx = {
      paddle: () => beep(880, 0.05, 'square', 0.03),
      wall:   () => beep(520, 0.04, 'sine',   0.025),
      score:  () => beep(330, 0.12, 'sawtooth', 0.035),
      start:  () => beep(660, 0.10, 'triangle', 0.035),
      win:    () => { beep(880,0.10,'triangle',0.035); setTimeout(()=>beep(1180,0.14,'triangle',0.04), 100); },
    };

    // =============================
    // ì´ˆê¸°í™” & ë¦¬ì…‹
    // =============================
    function resetGame(soft=false) {
      // soft=trueë©´ ì ìˆ˜/ë ˆë²¨ ìœ ì§€í•˜ê³  ë¼ìš´ë“œë§Œ ì¬ê°œ
      if (!soft) {
        scoreLeft = 0; scoreRight = 0; level = 1;
      }
      updateHUD();
      // íŒ¨ë“¤/ê³µ ìœ„ì¹˜ ì´ˆê¸°í™”
      leftPaddle.y = canvas.height/2 - leftPaddle.h/2;
      rightPaddle.y = canvas.height/2 - rightPaddle.h/2;
      placeBall((Math.random() < 0.5) ? -1 : 1);
      state = STATE.Idle;
      showOverlay('ì‹œì‘í•˜ê¸°', 'ã€â–¶ ì‹œì‘ã€‘ì„ ëˆ„ë¥´ê±°ë‚˜ ìº”ë²„ìŠ¤ë¥¼ í´ë¦­í•˜ë©´ ì‹œì‘í•©ë‹ˆë‹¤.\nì¡°ì‘: ì™¼ìª½ W/S Â· ì˜¤ë¥¸ìª½ â†‘/â†“');
      stopLoop();
    }

    function placeBall(dir=1) {
      ball.x = canvas.width/2; ball.y = canvas.height/2;
      // ë ˆë²¨ì— ë”°ë¥¸ ê¸°ë³¸ ì†ë„ ê°€ì¤‘ì¹˜
      const base = BALL_SPEED_BASE + (level-1) * 0.6;
      const angle = (Math.random()*0.6 - 0.3); // ì•½ê°„ ìƒ/í•˜ í¸ì°¨
      ball.vx = (base) * dir; // ì¢Œ/ìš° ë°©í–¥ ê³ ì •
      ball.vy = base * angle;
      ball.speed = Math.hypot(ball.vx, ball.vy);
    }

    // =============================
    // ë Œë”ë§
    // =============================
    function draw() {
      // ìº”ë²„ìŠ¤ í´ë¦¬ì–´ (í°ìƒ‰ ë°°ê²½)
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // ìƒ/í•˜ ê²½ê³„(ë„¤ì˜¨ ë¼ì¸)
      ctx.save();
      ctx.shadowColor = C_CYAN;
      ctx.shadowBlur = 12;
      ctx.fillStyle = C_CYAN;
      ctx.fillRect(0, 0, canvas.width, WALL_THICK);
      ctx.shadowColor = C_MAG;
      ctx.fillRect(0, canvas.height - WALL_THICK, canvas.width, WALL_THICK);
      ctx.restore();

      // ì¤‘ì•™ ë„¤íŠ¸(ì ì„ )
      ctx.setLineDash([12, 16]);
      ctx.lineWidth = 4;
      ctx.strokeStyle = '#ddd';
      ctx.beginPath();
      ctx.moveTo(canvas.width/2, WALL_THICK);
      ctx.lineTo(canvas.width/2, canvas.height - WALL_THICK);
      ctx.stroke();
      ctx.setLineDash([]);

      // íŒ¨ë“¤ (ë„¤ì˜¨ ê¸€ë¡œìš°)
      drawNeonRect(leftPaddle.x, leftPaddle.y, leftPaddle.w, leftPaddle.h, C_CYAN);
      drawNeonRect(rightPaddle.x, rightPaddle.y, rightPaddle.w, rightPaddle.h, C_MAG);

      // ê³µ (ë„¤ì˜¨ ë…¸ë‘)
      drawNeonBall(ball.x, ball.y, ball.size, C_YEL);
    }

    function drawNeonRect(x, y, w, h, color) {
      ctx.save();
      ctx.shadowColor = color; ctx.shadowBlur = 18; ctx.fillStyle = color;
      ctx.fillRect(x, y, w, h);
      ctx.restore();
    }

    function drawNeonBall(x, y, r, color) {
      ctx.save();
      ctx.shadowColor = color; ctx.shadowBlur = 16;
      ctx.fillStyle = color;
      ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
      ctx.restore();
    }

    // =============================
    // ì—…ë°ì´íŠ¸ (ë¬¼ë¦¬/ì…ë ¥/AI)
    // =============================
    function update() {
      // í”Œë ˆì´ì–´ ì…ë ¥ ì²˜ë¦¬ (ì™¼ìª½ WS / ì˜¤ë¥¸ìª½ â†‘â†“)
      if (keys.w) leftPaddle.y -= PADDLE_SPEED;
      if (keys.s) leftPaddle.y += PADDLE_SPEED;
      if (!singleMode) { // 2P ëª¨ë“œì—ì„œë§Œ í‚¤ë¡œ ì œì–´
        if (keys.up) rightPaddle.y -= PADDLE_SPEED;
        if (keys.down) rightPaddle.y += PADDLE_SPEED;
      }

      // ê²½ê³„ ì œí•œ
      leftPaddle.y = clamp(leftPaddle.y, WALL_THICK, canvas.height - WALL_THICK - leftPaddle.h);
      rightPaddle.y = clamp(rightPaddle.y, WALL_THICK, canvas.height - WALL_THICK - rightPaddle.h);

      // ì‹±ê¸€ ëª¨ë“œë©´ ì˜¤ë¥¸ìª½ íŒ¨ë“¤ AI ì´ë™
      if (singleMode) {
        const targetY = ball.y - rightPaddle.h/2; // ê³µ ì¤‘ì‹¬ ì¶”ì 
        const diff = targetY - rightPaddle.y;
        rightPaddle.y += clamp(diff * aiLag, -aiMaxSpeed, aiMaxSpeed);
      }

      // ê³µ ì´ë™
      ball.x += ball.vx; ball.y += ball.vy;

      // ìƒ/í•˜ ë²½ ë°˜ì‚¬
      if (ball.y - ball.size <= WALL_THICK) {
        ball.y = WALL_THICK + ball.size; ball.vy *= -1; sfx.wall();
      }
      if (ball.y + ball.size >= canvas.height - WALL_THICK) {
        ball.y = canvas.height - WALL_THICK - ball.size; ball.vy *= -1; sfx.wall();
      }

      // íŒ¨ë“¤ê³¼ ì¶©ëŒ ì²´í¬ (ì¢Œ)
      if (ball.x - ball.size <= leftPaddle.x + leftPaddle.w &&
          ball.y >= leftPaddle.y && ball.y <= leftPaddle.y + leftPaddle.h &&
          ball.vx < 0) {
        collideWithPaddle(leftPaddle, +1);
      }

      // íŒ¨ë“¤ê³¼ ì¶©ëŒ ì²´í¬ (ìš°)
      if (ball.x + ball.size >= rightPaddle.x &&
          ball.y >= rightPaddle.y && ball.y <= rightPaddle.y + rightPaddle.h &&
          ball.vx > 0) {
        collideWithPaddle(rightPaddle, -1);
      }

      // ì¢Œ/ìš° ê³¨ë¼ì¸ ì²˜ë¦¬ (ë“ì )
      if (ball.x + ball.size < 0) {
        // ì˜¤ë¥¸ìª½ ë“ì 
        scoreRight++;
        afterScore(+1);
      } else if (ball.x - ball.size > canvas.width) {
        // ì™¼ìª½ ë“ì 
        scoreLeft++;
        afterScore(-1);
      }
    }

    function collideWithPaddle(p, dir) {
      // íŒ¨ë“¤ê³¼ ì¶©ëŒ ì‹œ ë°˜ì‚¬ ê°ë„ëŠ” ë§ì€ ìœ„ì¹˜ì— ë”°ë¼ ë³€í™”
      const hitPos = (ball.y - (p.y + p.h/2)) / (p.h/2); // -1 ~ 1
      // ê¸°ë³¸ ì†ë„ëŠ” ë ˆë²¨ì— ë”°ë¼ ì ì§„ ì¦ê°€, rallyì— ë”°ë¼ ì†Œí­ ê°€ì‚°
      const speed = Math.min(18, Math.hypot(ball.vx, ball.vy) * 1.04 + (level * 0.15));
      const angle = hitPos * (Math.PI/3.2); // ìµœëŒ€ ~56ë„
      ball.vx = Math.cos(angle) * speed * dir;
      ball.vy = Math.sin(angle) * speed;
      ball.x = p.x + (dir>0 ? p.w + ball.size : -ball.size); // ë¼ì„ ë°©ì§€ ë³´ì •
      sfx.paddle();
    }

    function afterScore(lastDir) {
      sfx.score();
      // ì´ ë“ì  ìˆ˜ì— ë¹„ë¡€í•˜ì—¬ ë ˆë²¨ ì¦ê°€
      const total = scoreLeft + scoreRight;
      level = Math.max(1, 1 + Math.floor(total / 1)); // ë§¤ ë“ì ë§ˆë‹¤ 1ì”© ì¦ê°€ (ì²´ê° ì‰¬ì›€)

      // AI ë‚œì´ë„ë„ ë¯¸ì„¸ ìƒìŠ¹
      aiMaxSpeed = 6 + (level * 0.25); // ì ì°¨ ì¶”ì  ì†ë„ ì¦ê°€
      aiLag = Math.max(0.08, 0.12 - level * 0.003); // ë¯¸ì„¸í•˜ê²Œ ì˜ˆì¸¡ í–¥ìƒ

      // ëª©í‘œ ì ìˆ˜ ë‹¬ì„± ì‹œ ê²Œì„ ì¢…ë£Œ
      const target = clamp(parseInt(targetInput.value || '10', 10), 1, 30);
      if (scoreLeft >= target || scoreRight >= target) {
        state = STATE.Over;
        updateHUD();
        stopLoop();
        overlay.style.display = 'grid';
        const winner = (scoreLeft >= target) ? 'LEFT' : 'RIGHT';
        overlayTitle.textContent = `ê²Œì„ ì¢…ë£Œ - ${winner} ìŠ¹ë¦¬!`;
        overlayDesc.innerHTML = 'ã€âŸ² ë¦¬ì…‹ã€‘ìœ¼ë¡œ ìƒˆ ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”.';
        sfx.win();
        return;
      }

      // ë‹¤ìŒ ë¼ìš´ë“œë¡œ ê³µ ë¦¬ìŠ¤í° (ë§ˆì§€ë§‰ ë“ì ìì˜ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ ë°œì‚¬)
      updateHUD();
      placeBall(-lastDir);
    }

    function updateHUD() {
      scoreL.textContent = `LEFT ${scoreLeft}`;
      scoreR.textContent = `RIGHT ${scoreRight}`;
      levelBadge.textContent = `LV ${level}`;
      speedBadge.textContent = `SPEED ${Math.round(Math.hypot(ball.vx, ball.vy))}`;
    }

    // =============================
    // ìœ í‹¸
    // =============================
    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

    // =============================
    // ë©”ì¸ ë£¨í”„
    // =============================
    function loop() {
      update();
      draw();
      rafId = requestAnimationFrame(loop);
    }

    function startLoop() {
      if (rafId == null) rafId = requestAnimationFrame(loop);
    }

    function stopLoop() {
      if (rafId != null) { cancelAnimationFrame(rafId); rafId = null; }
    }

    function showOverlay(title, desc) {
      overlay.style.display = 'grid';
      overlayTitle.textContent = title;
      overlayDesc.innerHTML = desc.replace(/\n/g, '<br>');
    }
    function hideOverlay() { overlay.style.display = 'none'; }

    // =============================
    // ì…ë ¥ ì²˜ë¦¬ (í‚¤ë³´ë“œ)
    // =============================
    window.addEventListener('keydown', (e) => {
      switch (e.key) {
        case 'w': case 'W': keys.w = true; break;
        case 's': case 'S': keys.s = true; break;
        case 'ArrowUp': keys.up = true; break;
        case 'ArrowDown': keys.down = true; break;
        case ' ': // ìŠ¤í˜ì´ìŠ¤: ì¼ì‹œì •ì§€ í† ê¸€ (í”Œë ˆì´ ì¤‘ì¼ ë•Œ)
          if (state === STATE.Playing) togglePause();
          e.preventDefault();
          break;
      }
    });
    window.addEventListener('keyup', (e) => {
      switch (e.key) {
        case 'w': case 'W': keys.w = false; break;
        case 's': case 'S': keys.s = false; break;
        case 'ArrowUp': keys.up = false; break;
        case 'ArrowDown': keys.down = false; break;
      }
    });

    // ìº”ë²„ìŠ¤ í¬ì»¤ìŠ¤ìš©
    ovFocus.addEventListener('click', () => { canvas.focus(); });

    // =============================
    // ë²„íŠ¼ ì´ë²¤íŠ¸
    // =============================
    startBtn.addEventListener('click', startGame);
    ovStart.addEventListener('click', startGame);

    pauseBtn.addEventListener('click', () => {
      if (state === STATE.Playing) togglePause();
    });

    resetBtn.addEventListener('click', () => {
      resetGame(false);
    });

    soundBtn.addEventListener('click', () => {
      soundOn = !soundOn;
      soundBtn.textContent = soundOn ? 'ğŸ”Š ì‚¬ìš´ë“œ ON' : 'ğŸ”ˆ ì‚¬ìš´ë“œ OFF';
      soundBtn.setAttribute('aria-pressed', soundOn ? 'true' : 'false');
    });

    modeSelect.addEventListener('change', () => {
      singleMode = modeSelect.value === 'ai';
      // ëª¨ë“œ ë³€ê²½ ì‹œ ë¼ìš´ë“œë§Œ ì¬ì‹œì‘ (ì ìˆ˜ ìœ ì§€)
      placeBall((Math.random()<0.5)?-1:1);
      canvas.focus();
    });

    targetInput.addEventListener('change', () => {
      // ëª©í‘œ ì ìˆ˜ëŠ” 1~30 ì‚¬ì´ë¡œ ì œí•œ
      const v = clamp(parseInt(targetInput.value || '10', 10), 1, 30);
      targetInput.value = v;
    });

    // ìº”ë²„ìŠ¤ í´ë¦­ìœ¼ë¡œë„ ì‹œì‘/ì¼ì‹œì •ì§€ ì²˜ë¦¬
    canvas.addEventListener('click', () => {
      if (state === STATE.Idle) startGame();
      else if (state === STATE.Playing) togglePause();
    });

    // =============================
    // ê²Œì„ ìƒíƒœ ì „í™˜
    // =============================
    function startGame() {
      if (state === STATE.Playing) return;
      overlay.style.display = 'none';
      // ì˜¤ë””ì˜¤ ì´ˆê¸°í™” (ì‚¬ìš©ì ì œìŠ¤ì²˜ ì´í›„ ê°€ëŠ¥)
      ensureAudio(); sfx.start();

      // ìƒˆ ë¼ìš´ë“œ ë°°ì¹˜ (ì´ˆê¸° ì‹œì‘ ì‹œ)
      if (state === STATE.Idle) {
        // ì ìˆ˜íŒì´ ëª¨ë‘ 0ì´ê³  ë ˆë²¨ 1ì´ë©´ ì™„ì „ ì´ˆê¸°ë¡œ ê°„ì£¼
        if (scoreLeft === 0 && scoreRight === 0) {
          placeBall((Math.random()<0.5)?-1:1);
        }
      }
      state = STATE.Playing;
      startLoop();
      canvas.focus();
    }

    function togglePause() {
      if (state !== STATE.Playing) return;
      state = STATE.Paused;
      stopLoop();
      showOverlay('ì¼ì‹œ ì •ì§€', 'ìŠ¤í˜ì´ìŠ¤ë°” ë˜ëŠ” ã€â–¶ ì‹œì‘ã€‘ìœ¼ë¡œ ì¬ê°œ');
    }

    // ì˜¤ë²„ë ˆì´ì—ì„œ ì¬ê°œë¥¼ ìœ„í•´ startGame ì¬ì‚¬ìš©
    overlay.addEventListener('click', (e) => {
      if (state === STATE.Paused && (e.target === overlay || e.target === ovStart)) {
        overlay.style.display = 'none';
        state = STATE.Playing;
        startLoop();
        canvas.focus();
      }
    });

    // ì²« í™”ë©´ ì¤€ë¹„
    resetGame(false);
  </script>
</body>
</html>
